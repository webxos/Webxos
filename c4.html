<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Crunch - WebXOS 2025</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; font-family: 'Courier New', monospace; height: 100vh; overflow: hidden; color: #00ff00; }
        .console { width: 100vw; height: 100vh; background: #000; border: 1px solid #00ff00; padding: 10px; display: flex; flex-direction: column; font-size: clamp(14px, 3vw, 16px); }
        .output-area { flex-grow: 1; overflow-y: auto; padding-bottom: 10px; white-space: pre-wrap; word-wrap: break-word; }
        .input-container { position: sticky; bottom: 0; background: #000; padding-top: 10px; display: flex; gap: 10px; flex-wrap: wrap; }
        #messageInput { flex-grow: 1; background: #000; border: 1px solid #00ff00; color: #00ff00; padding: 8px; font-size: clamp(14px, 3vw, 16px); outline: none; }
        #executeBtn, #clearBtn { background: #000; border: 1px solid #00ff00; color: #00ff00; padding: 8px 12px; cursor: pointer; font-size: clamp(14px, 3vw, 16px); }
        #executeBtn:hover, #clearBtn:hover { background: #00ff00; color: #000; }
        .footer { text-align: center; padding: 5px; font-size: clamp(10px, 2vw, 12px); }
        .glow { text-shadow: 0 0 5px #00ff00; }
        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            border: 2px solid #00ff00;
            padding: 20px;
            color: #00ff00;
            font-size: clamp(14px, 3vw, 16px);
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            z-index: 1000;
            text-align: center;
            box-shadow: 0 0 20px #00ff00, inset 0 0 10px #00ff00;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 20px #00ff00, inset 0 0 10px #00ff00; }
            50% { box-shadow: 0 0 30px #00ff00, inset 0 0 15px #00ff00; }
            100% { box-shadow: 0 0 20px #00ff00, inset 0 0 10px #00ff00; }
        }
        .popup h2 {
            font-size: clamp(20px, 4vw, 24px);
            text-shadow: 0 0 10px #00ff00;
            margin-bottom: 20px;
        }
        .popup .certificate {
            border: 1px dashed #00ff00;
            padding: 15px;
            margin: 10px 0;
            background: #001100;
        }
        .popup .certificate p {
            margin: 10px 0;
        }
        .popup button {
            background: #000;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 8px 16px;
            margin: 10px;
            cursor: pointer;
            font-size: clamp(14px, 3vw, 16px);
            transition: all 0.3s;
        }
        .popup button:hover {
            background: #00ff00;
            color: #000;
            box-shadow: 0 0 10px #00ff00;
        }
        @media (max-width: 600px) {
            .console { padding: 5px; }
            .input-container { flex-direction: column; gap: 5px; }
            #executeBtn, #clearBtn { width: 100%; }
            .popup { width: 95%; padding: 10px; }
            .popup h2 { font-size: clamp(16px, 3vw, 18px); }
        }
    </style>
</head>
<body>
    <div class="console">
        <div class="output-area" id="consoleOutput"></div>
        <div class="input-container">
            <input type="text" id="messageInput" placeholder="Enter command or code...">
            <button id="executeBtn">EXECUTE</button>
            <button id="clearBtn">CLEAR</button>
        </div>
        <div class="footer">Â© 2025 WebXOS Code Crunch</div>
    </div>
    <div class="popup" id="endGamePopup">
        <div id="endGameStats"></div>
        <button id="copySerialBtn">Copy Serial</button>
        <button id="restartBtn">Restart Game</button>
    </div>
    <script>
        const input = document.getElementById('messageInput');
        const output = document.getElementById('consoleOutput');
        const executeBtn = document.getElementById('executeBtn');
        const clearBtn = document.getElementById('clearBtn');
        const popup = document.getElementById('endGamePopup');
        const endGameStats = document.getElementById('endGameStats');
        const copySerialBtn = document.getElementById('copySerialBtn');
        const restartBtn = document.getElementById('restartBtn');

        let state = 'welcome';
        let codeType = '';
        let device = '';
        let level = 0;
        let currentChallenge = '';
        let countdownTimer = null;
        let stats = {
            startTime: 0,
            totalTime: 0,
            correctChars: 0,
            totalChars: 0,
            errors: 0,
            levelTimes: [],
            levelWpms: []
        };

        // Code challenges (unchanged)
        const codeChallenges = {
            html: {
                1: ['<div>', '<span>', '<p>Text</p>'],
                2: ['<h1>Title</h1>', '<a href="#">Link</a>', '<img src="img.jpg">'],
                3: ['<ul><li>Item</li></ul>', '<br>', '<hr>'],
                4: ['<input type="text">', '<button>Click</button>', '<label>Input</label>'],
                5: ['<div class="box">Content</div>', '<p id="text">Hello</p>', '<a class="nav" href="#">Home</a>'],
                6: ['<header><h1>WebXOS</h1></header>', '<footer><p>2025</p></footer>', '<nav><a href="#">Menu</a></nav>'],
                7: ['<input type="checkbox" checked>', '<select><option>Value</option></select>', '<textarea placeholder="Text"></textarea>'],
                8: ['<div id="app" class="container">App</div>', '<section class="main">Content</section>', '<article><p>Story</p></article>'],
                9: ['<form action="/submit"><input type="text"></form>', '<table><tr><td>Cell</td></tr></table>', '<aside><p>Sidebar</p></aside>'],
                10: ['<header><nav><a href="#" class="active">Home</a></nav></header>', '<div class="grid" id="app">Dynamic Content</div>', '<main><h1>Code Crunch 2025</h1></main>']
            },
            css: {
                1: ['body { margin: 0; }', 'h1 { color: #fff; }', 'p { font-size: 16px; }'],
                2: ['.box { width: 100px; }', 'a { color: #00ff00; }', 'div { padding: 10px; }'],
                3: ['.item { margin: 5px; }', 'h2 { text-align: center; }', '.nav { display: block; }'],
                4: ['body { font-family: monospace; }', '.container { display: flex; }', '#header { background: #000; }'],
                5: ['.box { border: 1px solid #00ff00; }', 'p { line-height: 1.5; }', 'a:hover { color: #fff; }'],
                6: ['.grid { display: grid; gap: 10px; }', '.button { padding: 8px 16px; }', '.card { box-shadow: 0 0 5px #00ff00; }'],
                7: ['.nav { position: sticky; top: 0; }', 'div { border-radius: 5px; }', '.section { margin: 20px auto; }'],
                8: ['.flex { display: flex; justify-content: center; }', 'h1 { text-shadow: 0 0 5px #00ff00; }', '.item { transition: all 0.3s; }'],
                9: ['@media (max-width: 600px) { body { font-size: 14px; } }', '.container { flex-wrap: wrap; align-items: center; }', '.box { background: linear-gradient(#000, #00ff00); }'],
                10: ['body { display: flex; min-height: 100vh; flex-direction: column; }', '.grid { grid-template-columns: repeat(3, 1fr); gap: 20px; }', '.card { transform: translateY(0); box-shadow: 0 0 10px #00ff00; }']
            },
            js: {
                1: ['let x = 10;', 'const y = 5;', 'var z = 0;'],
                2: ['console.log("Hello");', 'alert("WebXOS");', 'let arr = [1, 2];'],
                3: ['if (x > 0) { x--; }', 'arr.push(3);', 'let obj = { key: "value" };'],
                4: ['function add(a, b) { return a + b; }', 'const sum = x + y;', 'arr.pop();'],
                5: ['let nums = [1, 2, 3].map(n => n * 2);', 'console.log(obj.key);', 'if (y < 10) y++;'],
                6: ['setTimeout(() => console.log("Done"), 1000);', 'const max = Math.max(...arr);', 'obj.name = "WebXOS";'],
                7: ['const sum = arr.reduce((a, b) => a + b, 0);', 'let str = `Hello ${x}`;', 'document.getElementById("app").innerHTML = "Hi";'],
                8: ['arr.filter(x => x > 1).forEach(x => console.log(x));', 'const promise = new Promise(resolve => resolve("Done"));', 'let event = new Event("click");'],
                9: ['async function fetchData() { return await fetch("/data"); }', 'try { throw new Error("Test"); } catch (e) {}', 'const debounce = (fn, ms) => { let t; return () => { clearTimeout(t); t = setTimeout(fn, ms); }; };'],
                10: ['document.addEventListener("click", () => console.log("Clicked"));', 'const app = document.getElementById("app"); app.innerHTML = "<h1>Code Crunch</h1>";', 'class Game { constructor() { this.score = 0; } }']
            },
            python: {
                1: ['x = 10', 'y = 5', 's = "Hello"'],
                2: ['print("WebXOS")', 'lst = [1, 2]', 'z = x + y'],
                3: ['if x > 0: x -= 1', 'lst.append(3)', 'd = {"key": "value"}'],
                4: ['def add(a, b): return a + b', 'print(len(lst))', 'lst.pop()'],
                5: ['squares = [x**2 for x in lst]', 'import math; print(math.pi)', 'if y < 10: y += 1'],
                6: ['import random; print(random.randint(1, 10))', 'from datetime import datetime', 'd["name"] = "WebXOS"'],
                7: ['lst = list(filter(lambda x: x > 1, lst))', 'print(sum(lst))', 'with open("file.txt", "r") as f: pass'],
                8: ['try: raise ValueError("Test") except: pass', 'import json; print(json.dumps(d))', 'from collections import Counter; print(Counter(lst))'],
                9: ['def factorial(n): return 1 if n == 0 else n * factorial(n-1)', 'import os; print(os.path.exists("file.txt"))', 'lst = [x for x in range(10) if x % 2 == 0]'],
                10: ['def game_loop(): score = 0; action = input("Action: "); return score', 'from datetime import datetime; print(datetime.now().strftime("%Y-%m-%d"))', 'import random; print([random.choice(lst) for _ in range(3)])']
            },
            git: {
                1: ['git init', 'git add .', 'git status'],
                2: ['git branch', 'git checkout main', 'git log'],
                3: ['git commit -m "Init"', 'git push', 'git pull'],
                4: ['git branch feature', 'git merge main', 'git diff'],
                5: ['git checkout -b dev', 'git stash', 'git fetch origin'],
                6: ['git commit -m "Update code"', 'git push origin feature', 'git pull origin main'],
                7: ['git reset --hard', 'git tag v1.0', 'git blame file.txt'],
                8: ['git remote add origin url', 'git rebase main', 'git stash pop'],
                9: ['git config --global user.name "User"', 'git clone https://github.com/user/repo.git', 'git log --oneline --graph'],
                10: ['git config --global user.email "user@example.com"', 'git push --set-upstream origin feature', 'git fetch origin; git rebase origin/main']
            },
            kernel: {
                1: ['MODULE_LICENSE("GPL");', '#include <linux/module.h>', '#include <linux/kernel.h>'],
                2: ['int init_module(void) { return 0; }', 'void cleanup_module(void) {}', 'printk("Hello");'],
                3: ['static int __init my_init(void) { return 0; }', 'module_init(my_init);', 'module_exit(my_exit);'],
                4: ['printk(KERN_INFO "WebXOS");', 'struct file_operations fops = {};', 'EXPORT_SYMBOL(my_func);'],
                5: ['void *kmalloc(size_t size, gfp_t flags);', 'struct task_struct *task = current;', 'spinlock_t my_lock;'],
                6: ['spin_lock_init(&my_lock);', 'struct mutex my_mutex;', 'mutex_init(&my_mutex);'],
                7: ['wait_queue_head_t wq; init_waitqueue_head(&wq);', 'struct work_struct work;', 'INIT_WORK(&work, work_func);'],
                8: ['struct timer_list timer; setup_timer(&timer, callback, 0);', 'printk(KERN_INFO "Module loaded");', 'static void my_exit(void) { printk("Exit"); }'],
                9: ['struct file_operations fops = { .owner = THIS_MODULE };', 'void *kzalloc(size_t size, gfp_t flags);', 'printk(KERN_DEBUG "Debug message");'],
                10: ['static int __init init_func(void) { printk(KERN_INFO "WebXOS Module"); return 0; }', 'static void __exit exit_func(void) { printk(KERN_INFO "Goodbye"); }', 'module_init(init_func); module_exit(exit_func);']
            },
            sql: {
                1: ['SELECT * FROM users;', 'INSERT INTO table (col) VALUES (1);', 'DELETE FROM table;'],
                2: ['UPDATE table SET col = 2;', 'SELECT id FROM users;', 'DROP TABLE temp;'],
                3: ['CREATE TABLE users (id INT);', 'SELECT COUNT(*) FROM table;', 'ALTER TABLE users ADD col;'],
                4: ['SELECT name FROM users WHERE id = 1;', 'INSERT INTO users (id) VALUES (2);', 'UPDATE users SET name = "User";'],
                5: ['DELETE FROM users WHERE id = 1;', 'SELECT * FROM users LIMIT 5;', 'CREATE INDEX idx ON users(id);'],
                6: ['SELECT AVG(price) FROM products;', 'JOIN table2 ON table1.id = table2.id;', 'SELECT * FROM users ORDER BY id;'],
                7: ['INSERT INTO orders (id, amount) VALUES (1, 100);', 'UPDATE users SET status = "active";', 'SELECT * FROM users WHERE age > 18;'],
                8: ['CREATE VIEW view1 AS SELECT * FROM users;', 'SELECT name, id FROM users GROUP BY name;', 'ALTER TABLE users DROP COLUMN col;'],
                9: ['SELECT u.name FROM users u JOIN orders o ON u.id = o.id;', 'DELETE FROM logs WHERE date < "2025-01-01";', 'SELECT * FROM products WHERE price > 100 LIMIT 10;'],
                10: ['CREATE TABLE products (id INT PRIMARY KEY, name VARCHAR(50));', 'SELECT category, COUNT(*) FROM products GROUP BY category;', 'SELECT u.name, o.order_id FROM users u LEFT JOIN orders o ON u.id = o.user_id;']
            },
            ruby: {
                1: ['x = 10', 'y = 5', 's = "Hello"'],
                2: ['puts "WebXOS"', 'arr = [1, 2]', 'z = x + y'],
                3: ['if x > 0 then x -= 1 end', 'arr << 3', 'h = { key: "value" }'],
                4: ['def add(a, b) a + b end', 'puts arr.length', 'arr.pop'],
                5: ['squares = arr.map { |x| x * x }', 'require "mathn"; puts Math::PI', 'if y < 10 then y += 1 end'],
                6: ['require "securerandom"; puts SecureRandom.random_number', 'h[:name] = "WebXOS"', 'puts arr.sum'],
                7: ['arr.select { |x| x > 1 }.each { |x| puts x }', 'require "json"; puts JSON.generate(h)', 'require "date"; puts Date.today'],
                8: ['begin; raise "Test"; rescue; end', 'puts arr.tally', 'require "fileutils"; puts FileUtils.pwd'],
                9: ['def factorial(n) n == 0 ? 1 : n * factorial(n-1) end', 'puts (1..10).select { |x| x.even? }', 'require "csv"; CSV.open("file.csv", "w") { }'],
                10: ['def game_loop; score = 0; puts "Score: #{score}"; gets; end', 'require "time"; puts Time.now.strftime("%Y-%m-%d")', 'puts arr.shuffle.first(3)']
            }
        };

        // WebXOS Serial Generation and Decoding
        function stringToHex(str) {
            return Array.from(str)
                .map(c => c.charCodeAt(0).toString(16).padStart(2, '0'))
                .join('')
                .toUpperCase();
        }

        function hexToString(hex) {
            let str = '';
            for (let i = 0; i < hex.length; i += 2) {
                str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
            }
            return str;
        }

        function encodeWebXOS(message) {
            if (!message || typeof message !== 'string') return 'WEBXOS-00000000-0000-0000-000000000000';
            const timestamp = Date.now().toString(36).toUpperCase().padStart(8, '0');
            const messageHex = stringToHex(message);
            const random1 = Math.random().toString(36).substr(2, 6).toUpperCase();
            const random2 = Math.random().toString(36).substr(2, 6).toUpperCase();
            const checksum = (message.length * 17).toString(36).toUpperCase().padStart(4, '0');
            return `WEBXOS-${timestamp}-${messageHex}-${random1}-${random2}-${checksum}`;
        }

        function decodeWebXOS(serial) {
            if (!serial || !serial.startsWith('WEBXOS-')) return { error: 'Invalid serial format' };
            const parts = serial.split('-');
            if (parts.length !== 6) return { error: 'Invalid serial structure' };

            const [prefix, timestamp, messageHex, random1, random2, checksum] = parts;
            if (prefix !== 'WEBXOS') return { error: 'Invalid prefix' };

            const timestampNum = parseInt(timestamp, 36);
            const timestampDate = new Date(timestampNum).toISOString();
            let message = '';
            try {
                message = hexToString(messageHex);
            } catch (e) {
                return { error: 'Invalid message hex' };
            }
            const expectedChecksum = (message.length * 17).toString(36).toUpperCase().padStart(4, '0');
            if (checksum !== expectedChecksum) return { error: 'Checksum mismatch' };

            return {
                timestamp: timestampDate,
                message: message,
                random1: random1,
                random2: random2,
                checksum: checksum
            };
        }

        // Display Functions
        function displayWelcome() {
            output.textContent = `Welcome to Code Crunch - WebXOS 2025\n\n`
                + `A typing challenge to test your coding speed and accuracy.\n`
                + `Complete 10 levels by typing random code snippets correctly.\n`
                + `Earn a WebXOS serial based on your performance.\n\n`
                + `Commands:\n`
                + `  start - Begin the game\n`
                + `  help  - Show help message\n`
                + `  clear - Clear the console\n\n`
                + `Type a command to proceed.\n`;
            state = 'welcome';
        }

        function displayHelp() {
            output.textContent = `Code Crunch - WebXOS 2025 Commands:\n`
                + `  start - Begin the game\n`
                + `  help  - Show this message\n`
                + `  clear - Clear the console\n`;
        }

        function displayCodeSelection() {
            output.textContent = `Select code type: html, css, js, python, git, kernel, sql, ruby\n`;
            state = 'selectCode';
        }

        function displayDeviceSelection() {
            output.textContent = `Select device: mobile, desktop\n`;
            state = 'selectDevice';
        }

        function startCountdown() {
            let count = 3;
            output.textContent = `Code Crunch starts in ${count}...\n`;
            state = 'countdown';
            countdownTimer = setInterval(() => {
                count--;
                if (count > 0) {
                    output.textContent = `Code Crunch starts in ${count}...\n`;
                } else {
                    clearInterval(countdownTimer);
                    startLevel();
                }
            }, 1000);
        }

        function startLevel() {
            level++;
            if (level > 10) {
                endGame();
                return;
            }
            const challenges = codeChallenges[codeType][level];
            currentChallenge = challenges[Math.floor(Math.random() * challenges.length)];
            output.textContent = `Level ${level}/10\nType the following code:\n${currentChallenge}\n`;
            state = 'playing';
            stats.startTime = performance.now();
            input.value = '';
        }

        function endGame() {
            const totalTime = stats.levelTimes.reduce((sum, time) => sum + time, 0) / 1000;
            const accuracy = stats.totalChars ? (stats.correctChars / stats.totalChars * 100).toFixed(2) : 0;
            const score = Math.round(accuracy * 10);
            const averageWpm = stats.levelWpms.length
                ? (stats.levelWpms.reduce((sum, wpm) => sum + wpm, 0) / stats.levelWpms.length).toFixed(2)
                : 0;
            const serial = encodeWebXOS(totalTime.toFixed(2));
            const completionDate = new Date().toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            // Generate minimized certificate HTML
            endGameStats.innerHTML = `
                <h2>WebXOS Code Crunch Certificate</h2>
                <div class="certificate">
                    <p>Congratulations on completing Code Crunch!</p>
                    <p>Final Score: ${score}/1000</p>
                    <p>Average WPM: ${averageWpm}</p>
                    <p>Total Time: ${totalTime.toFixed(2)} seconds</p>
                    <p>Completion Date: ${completionDate}</p>
                </div>
            `;
            popup.style.display = 'block';
            state = 'ended';
            input.disabled = true;
            executeBtn.disabled = true;
            clearBtn.disabled = true;

            copySerialBtn.onclick = () => {
                navigator.clipboard.writeText(serial).then(() => alert('Serial copied to clipboard!'));
            };
            restartBtn.onclick = () => {
                popup.style.display = 'none';
                input.disabled = false;
                executeBtn.disabled = false;
                clearBtn.disabled = false;
                level = 0;
                stats = {
                    startTime: 0,
                    totalTime: 0,
                    correctChars: 0,
                    totalChars: 0,
                    errors: 0,
                    levelTimes: [],
                    levelWpms: []
                };
                displayWelcome();
            };
        }

        // Input Processing
        function processInput() {
            const text = input.value.trim();
            if (!text) return;

            output.textContent += `> ${text}\n`;

            if (state === 'welcome') {
                if (text.toLowerCase() === 'start') {
                    displayCodeSelection();
                } else if (text.toLowerCase() === 'help') {
                    displayHelp();
                } else if (text.toLowerCase() === 'clear') {
                    output.textContent = '';
                    displayWelcome();
                } else {
                    output.textContent += `Unknown command. Type 'help' for commands.\n`;
                }
            } else if (state === 'selectCode') {
                if (['html', 'css', 'js', 'python', 'git', 'kernel', 'sql', 'ruby'].includes(text.toLowerCase())) {
                    codeType = text.toLowerCase();
                    displayDeviceSelection();
                } else {
                    output.textContent += `Invalid code type. Choose: html, css, js, python, git, kernel, sql, ruby\n`;
                }
            } else if (state === 'selectDevice') {
                if (['mobile', 'desktop'].includes(text.toLowerCase())) {
                    device = text.toLowerCase();
                    startCountdown();
                } else {
                    output.textContent += `Invalid device. Choose: mobile, desktop\n`;
                }
            } else if (state === 'playing') {
                const endTime = performance.now();
                const timeTaken = endTime - stats.startTime;
                stats.levelTimes.push(timeTaken);
                const charsTyped = text.length;
                stats.totalChars += charsTyped;
                const isCorrect = text === currentChallenge;
                if (isCorrect) {
                    stats.correctChars += charsTyped;
                    const words = charsTyped / 5;
                    const wpm = (words / (timeTaken / 1000 / 60)).toFixed(2);
                    stats.levelWpms.push(parseFloat(wpm));
                    output.textContent += `Correct! WPM: ${wpm}\n`;
                    startLevel();
                } else {
                    stats.errors++;
                    output.textContent += `Incorrect. Try again.\nType: ${currentChallenge}\n`;
                }
            }

            input.value = '';
            output.scrollTop = output.scrollHeight;
        }

        // Event Listeners
        executeBtn.addEventListener('click', processInput);
        clearBtn.addEventListener('click', () => {
            if (state !== 'ended') {
                output.textContent = '';
                displayWelcome();
            }
        });
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                processInput();
            }
        });

        // Anti-Cheating: Prevent Copy and Paste
        input.addEventListener('paste', (e) => {
            e.preventDefault();
            output.textContent += `Pasting is disabled to ensure fair play!\n`;
            stats.errors++;
            output.scrollTop = output.scrollHeight;
        });

        output.addEventListener('copy', (e) => {
            e.preventDefault();
            output.textContent += `Copying code is disabled to maintain challenge integrity!\n`;
            output.scrollTop = output.scrollHeight;
        });

        // Initialize
        displayWelcome();
    </script>
</body>
</html>
