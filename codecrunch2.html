<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Crunch - WebXOS 2025</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            font-family: 'Courier New', monospace;
            height: 100vh;
            overflow: hidden;
            color: #00ff00;
        }

        .console {
            width: 100vw;
            height: 100vh;
            background: #000;
            border: 1px solid #00ff00;
            padding: 10px;
            display: flex;
            flex-direction: column;
            font-size: clamp(14px, 3vw, 16px);
        }

        .output-area {
            flex-grow: 1;
            overflow-y: auto;
            padding-bottom: 10px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .input-container {
            position: sticky;
            bottom: 0;
            background: #000;
            padding-top: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        #messageInput {
            flex-grow: 1;
            background: #000;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 8px;
            font-size: clamp(14px, 3vw, 16px);
            outline: none;
        }

        #executeBtn, #clearBtn {
            background: #000;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 8px 12px;
            cursor: pointer;
            font-size: clamp(14px, 3vw, 16px);
        }

        #executeBtn:hover, #clearBtn:hover {
            background: #00ff00;
            color: #000;
        }

        .footer {
            text-align: center;
            padding: 5px;
            font-size: clamp(10px, 2vw, 12px);
        }

        .glow {
            text-shadow: 0 0 5px #00ff00;
        }

        .popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            border: 2px solid #00ff00;
            padding: 20px;
            color: #00ff00;
            font-size: clamp(14px, 3vw, 16px);
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            z-index: 1000;
            text-align: center;
        }

        .popup button {
            background: #000;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 8px 16px;
            margin: 10px;
            cursor: pointer;
            font-size: clamp(14px, 3vw, 16px);
        }

        .popup button:hover {
            background: #00ff00;
            color: #000;
        }

        @media (max-width: 600px) {
            .console {
                padding: 5px;
            }
            .input-container {
                flex-direction: column;
                gap: 5px;
            }
            #executeBtn, #clearBtn {
                width: 100%;
            }
            .popup {
                width: 95%;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="console">
        <div class="output-area" id="consoleOutput"></div>
        <div class="input-container">
            <input type="text" id="messageInput" placeholder="Enter command or code...">
            <button id="executeBtn">EXECUTE</button>
            <button id="clearBtn">CLEAR</button>
        </div>
        <div class="footer">Â© 2025 WebXOS Code Crunch</div>
    </div>
    <div class="popup" id="endGamePopup">
        <div id="endGameStats"></div>
        <button id="copySerialBtn">Copy Serial</button>
        <button id="restartBtn">Restart Game</button>
    </div>

    <script>
        const input = document.getElementById('messageInput');
        const output = document.getElementById('consoleOutput');
        const executeBtn = document.getElementById('executeBtn');
        const clearBtn = document.getElementById('clearBtn');
        const popup = document.getElementById('endGamePopup');
        const endGameStats = document.getElementById('endGameStats');
        const copySerialBtn = document.getElementById('copySerialBtn');
        const restartBtn = document.getElementById('restartBtn');

        let state = 'welcome';
        let codeType = '';
        let device = '';
        let level = 0;
        let currentChallenge = '';
        let countdownTimer = null;
        let stats = {
            startTime: 0,
            totalTime: 0,
            correctChars: 0,
            totalChars: 0,
            errors: 0,
            levelTimes: [],
            levelWpms: []
        };

        const codeChallenges = {
            html: [
                '<html>', '<head>', '<title>Hello</title>', '<body>', '<div>',
                '<p>Hello World</p>', '<h1>Title</h1>', '<a href="#">Link</a>', '<img src="img.jpg">', '<ul><li>Item</li></ul>',
                '<div class="container">\n  <h1>Welcome</h1>\n</div>',
                '<header>\n  <nav>\n    <a href="#">Home</a>\n  </nav>\n</header>',
                '<form>\n  <input type="text">\n  <button>Submit</button>\n</form>',
                '<table>\n  <tr>\n    <td>Cell</td>\n  </tr>\n</table>',
                '<section>\n  <article>\n    <p>Content</p>\n  </article>\n</section>',
                '<div id="app">\n  <h2>Data</h2>\n  <p>Dynamic</p>\n</div>',
                '<footer>\n  <p>Copyright 2025</p>\n  <a href="#">Contact</a>\n</footer>',
                '<main>\n  <section>\n    <h1>Main</h1>\n    <p>Intro</p>\n  </section>\n</main>',
                '<aside>\n  <h3>Sidebar</h3>\n  <ul>\n    <li>Link</li>\n  </ul>\n</aside>',
                '<html>\n<head>\n  <title>Page</title>\n</head>\n<body>\n  <h1>WebXOS</h1>\n  <p>Code Crunch</p>\n  <div>Game</div>\n  <footer>2025</footer>\n</body>\n</html>'
            ],
            css: [
                'body { margin: 0; }', 'h1 { color: #00ff00; }', '.box { width: 100px; }', 'p { font-size: 16px; }', 'a { text-decoration: none; }',
                '.container { display: flex; }', '#header { background: #000; }', '.item { margin: 10px; }', 'div { border: 1px solid #00ff00; }', 'nav { padding: 20px; }',
                '.grid {\n  display: grid;\n  gap: 10px;\n}',
                'body {\n  font-family: monospace;\n  color: #00ff00;\n}',
                '.button {\n  background: #000;\n  border: 1px solid #00ff00;\n}',
                '@media (max-width: 600px) {\n  body { font-size: 14px; }\n}',
                '.flex-container {\n  display: flex;\n  justify-content: center;\n}',
                'h1 {\n  text-align: center;\n  text-shadow: 0 0 5px #00ff00;\n}',
                '.card {\n  box-shadow: 0 0 5px #00ff00;\n  padding: 10px;\n}',
                '.nav {\n  position: sticky;\n  top: 0;\n  background: #000;\n}',
                '.section {\n  margin: 20px;\n  border-radius: 5px;\n}',
                'body {\n  background: #000;\n  color: #00ff00;\n  font-family: monospace;\n  display: flex;\n  flex-direction: column;\n  min-height: 100vh;\n  margin: 0;\n  padding: 10px;\n  overflow: hidden;\n}'
            ],
            js: [
                'let x = 10;', 'function add(a, b) { return a + b; }', 'const arr = [1, 2, 3];', 'console.log("Hello");', 'if (x > 0) { x--; }',
                'let obj = { name: "WebXOS" };', 'arr.push(4);', 'for (let i = 0; i < 5; i++) {}', 'const sum = arr.reduce((a, b) => a + b);', 'setTimeout(() => {}, 1000);',
                'function greet(name) {\n  return `Hello, ${name}`;\n}',
                'const data = arr.map(x => x * 2);',
                'document.getElementById("app").innerHTML = "Hi";',
                'async function fetchData() {\n  const res = await fetch(url);\n}',
                'class Game {\n  constructor() {\n    this.score = 0;\n  }\n}',
                'const event = new Event("click");\n  elem.dispatchEvent(event);',
                'try {\n  throw new Error("Test");\n} catch (e) {}',
                'const promise = new Promise((resolve) => {\n  resolve("Done");\n});',
                'const debounce = (fn, ms) => {\n  let timeout;\n  return () => {\n    clearTimeout(timeout);\n    timeout = setTimeout(fn, ms);\n  };\n}',
                'document.addEventListener("DOMContentLoaded", () => {\n  const app = document.getElementById("app");\n  app.innerHTML = "<h1>Code Crunch</h1>";\n  let score = 0;\n  const button = document.createElement("button");\n  button.textContent = "Click";\n  button.addEventListener("click", () => score++);\n  app.appendChild(button);\n});'
            ],
            python: [
                'x = 10', 'def add(a, b): return a + b', 'lst = [1, 2, 3]', 'print("Hello")', 'if x > 0: x -= 1',
                'class Game: pass', 'for i in range(5): pass', 'lst.append(4)', 'import math', 'with open("file.txt") as f: pass',
                'def greet(name):\n    return f"Hello, {name}"',
                'lst = [x * 2 for x in lst]',
                'try:\n    raise ValueError("Test")\nexcept ValueError:\n    pass',
                'import random\nrandom.randint(1, 10)',
                'from datetime import datetime\ndatetime.now()',
                'def factorial(n):\n    if n == 0:\n        return 1\n    return n * factorial(n-1)',
                'import json\njson.dumps({"key": "value"})',
                'from collections import Counter\nCounter([1, 1, 2, 3])',
                'import os\nos.path.exists("file.txt")',
                'def game_loop():\n    score = 0\n    while True:\n        print("Score:", score)\n        action = input("Action: ")\n        if action == "quit":\n            break\n        score += 1\n    return score'
            ],
            git: [
                'git init', 'git add .', 'git commit -m "Initial commit"', 'git status', 'git branch',
                'git checkout -b feature', 'git push origin main', 'git pull', 'git merge branch', 'git log',
                'git clone https://github.com/user/repo.git',
                'git remote add origin https://github.com/user/repo.git',
                'git diff',
                'git stash',
                'git reset --hard',
                'git rebase main',
                'git tag v1.0',
                'git fetch origin',
                'git blame file.txt',
                'git config --global user.email "user@example.com"\ngit config --global user.name "User"'
            ],
            kernel: [
                '#include <linux/module.h>', 'MODULE_LICENSE("GPL");', 'int init_module(void) { return 0; }', 'void cleanup_module(void) {}', 'printk(KERN_INFO "Hello");',
                'static int __init my_init(void) { return 0; }', 'module_init(my_init);', 'module_exit(my_exit);', 'struct file_operations fops = {};', 'EXPORT_SYMBOL(my_func);',
                '#define MODULE\n#include <linux/kernel.h>',
                'static void my_exit(void) {\n    printk(KERN_INFO "Exit");\n}',
                'struct task_struct *task;\ntask = current;',
                'void *kmalloc(size_t size, gfp_t flags);',
                'spinlock_t my_lock;\nspin_lock_init(&my_lock);',
                'struct mutex my_mutex;\nmutex_init(&my_mutex);',
                'wait_queue_head_t wq;\ninit_waitqueue_head(&wq);',
                'struct work_struct work;\nINIT_WORK(&work, work_func);',
                'struct timer_list timer;\nsetup_timer(&timer, callback, 0);',
                '#include <linux/module.h>\n#include <linux/kernel.h>\nMODULE_LICENSE("GPL");\nstatic int __init init_func(void) {\n    printk(KERN_INFO "WebXOS Kernel Module");\n    return 0;\n}\nstatic void __exit exit_func(void) {\n    printk(KERN_INFO "Goodbye");\n}\nmodule_init(init_func);\nmodule_exit(exit_func);'
            ],
            sql: [
                'SELECT * FROM users;', 'INSERT INTO table (col) VALUES (1);', 'UPDATE table SET col = 2;', 'DELETE FROM table WHERE id = 1;', 'CREATE TABLE users (id INT);',
                'SELECT name FROM users WHERE id = 1;', 'ALTER TABLE users ADD column VARCHAR(50);', 'DROP TABLE users;', 'SELECT COUNT(*) FROM table;', 'JOIN table2 ON table1.id = table2.id;',
                'SELECT * FROM users\nWHERE age > 18\nORDER BY name;',
                'INSERT INTO orders (user_id, amount)\nVALUES (1, 100);',
                'UPDATE users\nSET status = "active"\nWHERE id = 1;',
                'CREATE INDEX idx_name\nON users (name);',
                'SELECT AVG(price)\nFROM products\nGROUP BY category;',
                'SELECT u.name, o.order_id\nFROM users u\nJOIN orders o ON u.id = o.user_id;',
                'DELETE FROM logs\nWHERE created_at < "2025-01-01";',
                'CREATE VIEW active_users AS\nSELECT * FROM users\nWHERE active = 1;',
                'SELECT * FROM employees\nWHERE salary > 50000\nLIMIT 10;',
                'CREATE TABLE products (\n  id INT PRIMARY KEY,\n  name VARCHAR(100),\n  price DECIMAL(10,2),\n  category VARCHAR(50)\n);'
            ],
            ruby: [
                'x = 10', 'def add(a, b) a + b end', 'arr = [1, 2, 3]', 'puts "Hello"', 'if x > 0 then x -= 1 end',
                'class Game; end', '5.times { }', 'arr << 4', 'require "math"', 'File.open("file.txt") { }',
                'def greet(name)\n  "Hello, #{name}"\nend',
                'arr.map { |x| x * 2 }',
                'begin\n  raise "Test"\nrescue\nend',
                'require "securerandom"\nSecureRandom.random_number(10)',
                'require "date"\nDate.today',
                'def factorial(n)\n  n == 0 ? 1 : n * factorial(n-1)\nend',
                'require "json"\nJSON.generate({key: "value"})',
                'arr.tally',
                'require "fileutils"\nFileUtils.exist?("file.txt")',
                'def game_loop\n  score = 0\n  loop do\n    puts "Score: #{score}"\n    action = gets.chomp\n    break if action == "quit"\n    score += 1\n  end\n  score\nend'
            ]
        };

        // WebXOS Serial Generation
        function stringToHex(str) {
            return Array.from(str)
                .map(c => c.charCodeAt(0).toString(16).padStart(2, '0'))
                .join('')
                .toUpperCase();
        }

        function encodeWebXOS(message) {
            if (!message || typeof message !== 'string') return 'WEBXOS-00000000-0000-0000-000000000000';
            const timestamp = Date.now().toString(36).toUpperCase().padStart(8, '0');
            const messageHex = stringToHex(message);
            const random1 = Math.random().toString(36).substr(2, 6).toUpperCase();
            const random2 = Math.random().toString(36).substr(2, 6).toUpperCase();
            const checksum = (message.length * 17).toString(36).toUpperCase().padStart(4, '0');
            return `WEBXOS-${timestamp}-${messageHex}-${random1}-${random2}-${checksum}`;
        }

        // Display Functions
        function displayWelcome() {
            output.textContent = `Welcome to Code Crunch - WebXOS 2025\n\n`
                + `A typing challenge to test your coding speed and accuracy.\n`
                + `Complete 20 levels by typing code snippets correctly.\n`
                + `Earn a WebXOS serial based on your performance.\n\n`
                + `Commands:\n`
                + `  start - Begin the game\n`
                + `  help  - Show help message\n`
                + `  clear - Clear the console\n\n`
                + `Type a command to proceed.\n`;
            state = 'welcome';
        }

        function displayHelp() {
            output.textContent = `Code Crunch - WebXOS 2025
Commands:
  start - Begin the game
  help  - Show this message
  clear - Clear the console
`;
        }

        function displayCodeSelection() {
            output.textContent = `Select code type: html, css, js, python, git, kernel, sql, ruby\n`;
            state = 'selectCode';
        }

        function displayDeviceSelection() {
            output.textContent = `Select device: mobile, desktop\n`;
            state = 'selectDevice';
        }

        function startCountdown() {
            let count = 3;
            output.textContent = `Code Crunch starts in ${count}...\n`;
            state = 'countdown';
            countdownTimer = setInterval(() => {
                count--;
                if (count > 0) {
                    output.textContent = `Code Crunch starts in ${count}...\n`;
                } else {
                    clearInterval(countdownTimer);
                    startLevel();
                }
            }, 1000);
        }

        function startLevel() {
            level++;
            if (level > 20) {
                endGame();
                return;
            }
            currentChallenge = codeChallenges[codeType][level - 1];
            output.textContent = `Level ${level}/20\nType the following code:\n${currentChallenge}\n`;
            state = 'playing';
            stats.startTime = performance.now();
            input.value = '';
        }

        function endGame() {
            const totalTime = stats.levelTimes.reduce((sum, time) => sum + time, 0) / 1000;
            const accuracy = stats.totalChars ? (stats.correctChars / stats.totalChars * 100).toFixed(2) : 0;
            const score = Math.round(accuracy * 20); // Max 2000 points
            const averageWpm = stats.levelWpms.length
                ? (stats.levelWpms.reduce((sum, wpm) => sum + wpm, 0) / stats.levelWpms.length).toFixed(2)
                : 0;
            const strengths = accuracy >= 90 ? 'High accuracy' : 'Consistent completion';
            const weaknesses = stats.errors >= 5 ? 'Frequent errors' : 'None';
            const serial = encodeWebXOS(totalTime.toFixed(2));

            endGameStats.textContent = `Code Crunch Complete!\nFinal Score: ${score}/2000\nAverage WPM: ${averageWpm}\nTotal Time: ${totalTime.toFixed(2)} seconds\nStrengths: ${strengths}\nWeaknesses: ${weaknesses}\nWebXOS Serial: ${serial}\n`;
            popup.style.display = 'block';
            state = 'ended';
            input.disabled = true;
            executeBtn.disabled = true;
            clearBtn.disabled = true;

            copySerialBtn.onclick = () => {
                navigator.clipboard.writeText(serial).then(() => alert('Serial copied to clipboard!'));
            };
            restartBtn.onclick = () => {
                popup.style.display = 'none';
                input.disabled = false;
                executeBtn.disabled = false;
                clearBtn.disabled = false;
                level = 0;
                stats = {
                    startTime: 0,
                    totalTime: 0,
                    correctChars: 0,
                    totalChars: 0,
                    errors: 0,
                    levelTimes: [],
                    levelWpms: []
                };
                displayWelcome();
            };
        }

        // Input Processing
        function processInput() {
            const text = input.value.trim();
            if (!text) return;

            output.textContent += `> ${text}\n`;

            if (state === 'welcome') {
                if (text.toLowerCase() === 'start') {
                    displayCodeSelection();
                } else if (text.toLowerCase() === 'help') {
                    displayHelp();
                } else if (text.toLowerCase() === 'clear') {
                    output.textContent = '';
                    displayWelcome();
                } else {
                    output.textContent += `Unknown command. Type 'help' for commands.\n`;
                }
            } else if (state === 'selectCode') {
                if (['html', 'css', 'js', 'python', 'git', 'kernel', 'sql', 'ruby'].includes(text.toLowerCase())) {
                    codeType = text.toLowerCase();
                    displayDeviceSelection();
                } else {
                    output.textContent += `Invalid code type. Choose: html, css, js, python, git, kernel, sql, ruby\n`;
                }
            } else if (state === 'selectDevice') {
                if (['mobile', 'desktop'].includes(text.toLowerCase())) {
                    device = text.toLowerCase();
                    startCountdown();
                } else {
                    output.textContent += `Invalid device. Choose: mobile, desktop\n`;
                }
            } else if (state === 'playing') {
                const endTime = performance.now();
                const timeTaken = endTime - stats.startTime;
                stats.levelTimes.push(timeTaken);
                const charsTyped = text.length;
                stats.totalChars += charsTyped;
                const isCorrect = text === currentChallenge;
                if (isCorrect) {
                    stats.correctChars += charsTyped;
                    const words = charsTyped / 5;
                    const wpm = (words / (timeTaken / 1000 / 60)).toFixed(2);
                    stats.levelWpms.push(parseFloat(wpm));
                    output.textContent += `Correct! WPM: ${wpm}\n`;
                    startLevel();
                } else {
                    stats.errors++;
                    output.textContent += `Incorrect. Try again.\nType: ${currentChallenge}\n`;
                }
            }

            input.value = '';
            output.scrollTop = output.scrollHeight;
        }

        // Event Listeners
        executeBtn.addEventListener('click', processInput);
        clearBtn.addEventListener('click', () => {
            if (state !== 'ended') {
                output.textContent = '';
                displayWelcome();
            }
        });
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                processInput();
            }
        });

        // Anti-Cheating: Prevent Copy and Paste
        input.addEventListener('paste', (e) => {
            e.preventDefault();
            output.textContent += `Pasting is disabled to ensure fair play!\n`;
            stats.errors++; // Penalize paste attempts
            output.scrollTop = output.scrollHeight;
        });

        output.addEventListener('copy', (e) => {
            e.preventDefault();
            output.textContent += `Copying code is disabled to maintain challenge integrity!\n`;
            output.scrollTop = output.scrollHeight;
        });

        // Initialize
        displayWelcome();
    </script>
</body>
</html>