<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mission Control Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Orbitron', sans-serif;
            background: #000;
            color: #39FF14;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            overscroll-behavior: none;
            touch-action: none;
        }
        #dashboard {
            display: flex;
            flex-direction: column;
            width: calc(100vw - 8px);
            max-width: 500px;
            min-height: calc(100vh - 20px);
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid #39FF14;
            border-radius: 6px;
            padding: 6px;
            box-shadow: 0 0 6px #39FF14;
            gap: 4px;
        }
        #hud {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #39FF14;
            border-radius: 4px;
            padding: 4px;
            font-size: clamp(0.5rem, 1.8vw, 0.6rem);
            text-shadow: 0 0 1px #39FF14;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #hud-toggle {
            cursor: pointer;
            font-size: clamp(0.6rem, 2vw, 0.7rem);
        }
        #globe-widget {
            position: relative;
            width: 100%;
            height: clamp(100px, 25vw, 120px);
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 0 4px #39FF14;
            cursor: pointer;
            background: #000;
        }
        #agent-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #39FF14 #000;
        }
        .agent-widget {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #39FF14;
            border-radius: 4px;
            padding: 6px;
            font-size: clamp(0.5rem, 1.8vw, 0.6rem);
            text-shadow: 0 0 1px #39FF14;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 4px;
        }
        .agent-data { display: flex; flex-direction: column; }
        .agent-controls { display: flex; gap: 4px; align-items: center; }
        .control-bar {
            display: flex;
            gap: 6px;
            justify-content: center;
            flex-wrap: wrap;
            padding: 4px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #39FF14;
            border-radius: 4px;
        }
        button {
            background: transparent;
            border: 1px solid #39FF14;
            color: #39FF14;
            padding: 4px 8px;
            font-size: clamp(0.5rem, 1.8vw, 0.6rem);
            border-radius: 3px;
            cursor: pointer;
            text-shadow: 0 0 1px #39FF14;
            transition: all 0.2s;
            touch-action: manipulation;
        }
        button:hover {
            background: #39FF14;
            color: #000;
            box-shadow: 0 0 4px #39FF14;
        }
        button:disabled {
            border-color: #333;
            color: #333;
            cursor: not-allowed;
        }
        select, input[type="checkbox"], input[type="text"], input[type="number"] {
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #39FF14;
            color: #39FF14;
            padding: 4px;
            font-size: clamp(0.5rem, 1.8vw, 0.6rem);
            border-radius: 3px;
            touch-action: manipulation;
        }
        select:disabled, input:disabled {
            border-color: #333;
            color: #333;
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid #39FF14;
            padding: 8px;
            border-radius: 6px;
            box-shadow: 0 0 8px #39FF14;
            width: 90%;
            max-width: 300px;
            z-index: 10;
        }
        .modal h2 {
            font-size: clamp(0.6rem, 2vw, 0.7rem);
            text-shadow: 0 0 1px #39FF14;
            margin-bottom: 6px;
        }
        .modal label {
            font-size: clamp(0.5rem, 1.8vw, 0.6rem);
            margin: 4px 0 2px;
            display: block;
        }
        .modal input, .modal select {
            width: 100%;
            margin-bottom: 4px;
            font-size: clamp(0.5rem, 1.8vw, 0.6rem);
        }
        .modal .control-bar {
            justify-content: space-between;
        }
        #globe-modal {
            width: 95vw;
            height: 90vh;
            max-width: 600px;
            max-height: 600px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.98);
            border-radius: 8px;
            box-shadow: 0 0 10px #39FF14;
        }
        #globe-modal h2 {
            font-size: clamp(0.7rem, 2.5vw, 0.8rem);
            text-align: center;
            margin-bottom: 6px;
        }
        #globe-modal-canvas {
            width: 100%;
            height: 80%;
            border-radius: 4px;
            box-shadow: 0 0 4px #39FF14;
            background: #000;
        }
        #globe-modal .control-bar {
            display: flex;
            gap: 6px;
            justify-content: center;
            align-items: center;
            margin-top: 6px;
        }
        #agent-select {
            width: auto;
            padding: 4px 8px;
        }
        .zoom-btn {
            width: 28px;
            height: 28px;
            padding: 0;
            line-height: 28px;
            text-align: center;
            font-size: 0.9rem;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9;
        }
        @media (min-width: 600px) {
            #dashboard {
                max-width: 500px;
                margin: 8px auto;
            }
            #hud { font-size: clamp(0.6rem, 1.8vw, 0.7rem); }
            #globe-widget { height: clamp(120px, 20vw, 140px); }
            .agent-widget { font-size: clamp(0.6rem, 1.8vw, 0.7rem); }
            button, select, input { font-size: clamp(0.6rem, 1.8vw, 0.7rem); padding: 5px; }
            .modal { max-width: 320px; }
            .modal h2 { font-size: clamp(0.7rem, 2vw, 0.8rem); }
            .modal label, .modal input, .modal select { font-size: clamp(0.6rem, 1.8vw, 0.7rem); }
            #globe-modal { max-width: 600px; max-height: 600px; }
            #globe-modal-canvas { height: 82%; }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="overlay" id="modal-overlay"></div>
    <div id="dashboard">
        <div id="hud">
            <span id="hud-data">Agents: 0 | Status: Initializing</span>
            <span id="hud-toggle" onclick="toggleHUD()">▼</span>
        </div>
        <div id="globe-widget" onclick="globeWidget.openModal()"></div>
        <div id="agent-panel"></div>
        <div class="control-bar">
            <button onclick="toggleSimulator()">Sim</button>
            <button id="launch-seq" onclick="missionControl.launchSequence()">Launch</button>
            <button onclick="missionControl.pause()">Pause</button>
            <button onclick="missionControl.reset()">Reset</button>
        </div>
    </div>
    <div id="copyright">© 2025 WebXOS</div>
    <div id="config-modal" class="modal">
        <h2>Agent <span id="modal-agent-id"></span> Config</h2>
        <label for="agent-role">Role</label>
        <select id="agent-role">
            <option value="Rocket">Rocket</option>
            <option value="Drone">Drone</option>
            <option value="Satellite">Satellite</option>
            <option value="Rover">Rover</option>
        </select>
        <label for="agent-task">Task</label>
        <select id="agent-task">
            <option value="None">None</option>
            <option value="Launch">Launch</option>
            <option value="Orbit">Orbit</option>
            <option value="Hold">Hold</option>
            <option value="Survey">Survey</option>
            <option value="Return">Return</option>
            <option value="Land">Land</option>
            <option value="Navigate">Navigate</option>
        </select>
        <label for="api-endpoint">API Endpoint</label>
        <input id="api-endpoint" placeholder="API URL">
        <label for="api-key">API Key</label>
        <input id="api-key" placeholder="API Key">
        <label for="iot-id">IoT Device ID</label>
        <input id="iot-id" placeholder="Device ID">
        <label for="altitude-target">Altitude Target (km)</label>
        <input id="altitude-target" type="number" min="0" value="0">
        <label for="speed-target">Speed Target (km/h)</label>
        <input id="speed-target" type="number" min="0" value="0">
        <div class="control-bar">
            <button onclick="missionControl.testConfig()">Test</button>
            <button onclick="missionControl.saveConfig()">Save</button>
            <button onclick="closeModal('config-modal')">Close</button>
        </div>
    </div>
    <div id="globe-modal" class="modal">
        <h2>GPS Tracking Map</h2>
        <div id="globe-modal-canvas"></div>
        <div class="control-bar">
            <button class="zoom-btn" onclick="globeWidget.zoom(1)">+</button>
            <button class="zoom-btn" onclick="globeWidget.zoom(-1)">-</button>
            <select id="agent-select" onchange="globeWidget.focusAgent(this.value)">
                <option value="all">All Agents</option>
                <option value="1">Agent 1 (Rocket)</option>
                <option value="2">Agent 2 (Drone)</option>
                <option value="3">Agent 3> (Satellite)</option>
                <option value="4">Agent 4 (Rover)</option>
                <option value="5">Agent 5 (Rocket)</option>
                <option value="6">Agent 6 (Drone)</option>
                <option value="7">Agent 7 (Satellite)</option>
                <option value="8">Agent 8 (Rocket)</option>
            </select>
            <button onclick="closeModal('globe-modal')">Close</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/jsm/controls/OrbitControls.js"></script>
    <script>
        let simulatorMode = true;
        let ws = null;
        let isPaused = false;

        class MissionControl {
            constructor() {
                this.agents = [
                    { id: 1, role: 'Rocket', role: 'Idle', task: 'None', location: { lat: 28.5, lng: -80.5, alt: 0 }, api: { endpoint: '', key: '' }, iotDeviceId: '', targetAltitude: 100, targetSpeed: 0, quantumLinked: false, path: [], velocity: { v: 0, lat: 0, lng: 0 }, orbit: { a: 0, e: 0 } },
                    { id: 2, role: 'Drone', status: 'Idle', task: 'None', location: { lat: -33.8, lng: 151.2, alt: 100 }, api: { endpoint: '', key: '' }, iotDeviceId: '', targetAltitude: 5, targetSpeed: 40, quantumLinked: false, path: [], velocity: { v: 0, lat: 0, lng: 0 }, orbit: { a: 0, e: 0 } },
                    { id: 3, role: 'Satellite', status: 'Idle', task: 'None', location: { lat: 0, lng: 0, alt: 36000 }, api: { endpoint: '', key: '' }, iotDeviceId: '', targetAltitude: 500, targetSpeed: 27000, quantumLinked: true, path: [], velocity: { v: 7.8, lat: 0, lng: 0.1 }, orbit: { a: 6371 + 36000, e: 0.01 } },
                    { id: 4, role: 'Rover', status: 'Idle', task: 'None', location: { lat: 35.2, lng: -117.4, alt: 0 }, api: { endpoint: '', key: '' }, iotDeviceId: '', targetAltitude: 0, targetSpeed: 2, quantumLinked: false, path: [], velocity: { v: 0, lat: 0, lng: 0 }, orbit: { a: 0, e: 0 } },
                    { id: 5, role: 'Rocket', status: 'Idle', task: 'None', location: { lat: 45.5, lng: 9.2, alt: 0 }, api: { endpoint: '', key: '' }, iotDeviceId: '', targetAltitude: 200, targetSpeed: 0, quantumLinked: false, path: [], velocity: { v: 0, lat: 0, lng: 0 }, orbit: { a: 0, e: 0 } },
                    { id: 6, role: 'Drone', status: 'Idle', task: 'None', location: { lat: 22.3, lng: 114.2, alt: 120 }, api: { endpoint: '', key: '' }, iotDeviceId: '', targetAltitude: 4, targetSpeed: 50, quantumLinked: false: path: [], velocity: { v: 0, lat: 0, lng: 0 }, orbit: { a: 0, e: 0 } },
                    { id: 7, role: 'Satellite', status: 'Idle', task: 'None', location: { lat: 10, lng: -30, alt: 40000 }, api: { endpoint: '', key: '' }, iotDeviceId: '', targetAltitude: 600, targetSpeed: 28000, quantumLinked: true, path: [], velocity: { v: 7.6, lat: 0, lng: 0.1 }, orbit: { a: 6371 + 40000, e: 0.02 } },
                    { id: 8, role: 'Rocket', status: 'Idle', task: 'None', location: { lat: -23.5, lng: -46.6, alt: 0 }, api: { endpoint: '', key: '' }, iotDeviceId: '', targetAltitude: 150, targetSpeed: 0, quantumLinked: false, path: [], velocity: { v: 0, lat: 0, lng: 0 }, orbit: { a: 0, e: 0 } }
                ];
                this.apiConnections = {};
            }

            setTask(id, id, task) {
                try {
                    const agent = this.agents.find(a => a.id === id);
                    agent.task = task;
                    agent.status = task === 'None' ? 'Idle' : `Exec ${task}`;
                    agent.velocity.v = task === 'None' ? 0 : agent.targetSpeed / 3600;
                    if (agent.quantumLinked) {
                        this.agents.forEach(other => {
                            if (other.id !== id)) {
                                other.task = agent.task;
                            } else.status = agent.status;
                                other.velocity.v = agent.velocity.v;
                            }
                        });
                    }
                    if (!simulatorMode && this.apiConnections[id]?.valid) {
                        this.fetchTelemetry(id, task);
                        this.fetchIoT(id);
                        if (agent.role === 'Satellite' || agent.role === 'Satellite') this.fetchData(id);
                    }
                    updateAgentList();
                    globeWidget.update();
                } catch (e) {
                    console.error('Set task error:', e);
                    document.getElementById('hud-data').innerText = 'Task Error';
                }
            }

            toggleQuantum(id) {
                try {
                    const agent = this.agents.find(a => a.id === id);
                    agent.quantumLinked = !agent.quantumLinked;
                    if (agent.quantumLinked && agent.task !== 'None') {
                        this.agents.forEach(other => {
                            if (other.id !== id) {
                                other.task = agent.task;
                                other.status = agent.status;
                                other.velocity.v = agent.velocity.v;
                            }
                        });
                    }
                    updateAgentList();
                } catch (e) {
                    console.error('Toggle quantum error:', e);
                    document.getElementById('hud-data').innerText = 'Quantum Error';
                }
            }

            launchSequence() {
                try {
                    if (isPaused) return;
                    const seq = ['Pre', 'Launch', 'Asc', 'Orbit', 'Land'];
                    let step = 0;
                    const interval = setInterval(() => {
                        if (isPaused || step >= seq.length) {
                            clearInterval(interval);
                            return;
                        }
                        this.agents.forEach(agent => {
                            if (agent.role !== 'Satellite' && agent.role !== 'Rover') {
                                agent.task = seq[step];
                                agent.status = `Exec ${seq[step]}`;
                                agent.location.alt = agent.targetAltitude * (step + 1) / seq.length;
                                agent.velocity.v = agent.targetSpeed / 3600 * (step + 1) / seq.length;
                                agent.path.push({ ...agent.location });
                                if (agent.path.length > 50) agent.path.shift();
                                if (!simulatorMode && this.apiConnections[agent.id]?.valid) {
                                    this.fetchTelemetry(agent.id, seq[step]);
                                    this.fetchApi(agent.id);
                                }
                            }
                        });
                        updateAgentList();
                        step++;
                    }, 1000);
                } catch (e) {
                    console.error('Launch sequence error:', e);
                    document.getElementById('hud-data').innerText = 'Launch Error';
                }
            }

            pause() {
                try {
                    isPaused = !isPaused;
                    document.getElementById('hud-data').innerText = isPaused ? `Paused | Agents: ${this.agents.length}` : `Running | Agents: ${this.agents.length}`;
                } catch (e) {
                    console.error('Pause error:', e);
                    document.getElementById('hud-data').innerText = 'Pause Error';
                }
            }

            reset() {
                try {
                    isPaused = false;
                    this.agents.forEach(agent => {
                        agent.status = 'Idle';
                        agent.task = 'None';
                        agent.location.alt = agent.role === 'Satellite' ? agent.targetAltitude : 0;
                        agent.velocity.v = 0;
                        agent.path = [];
                        agent.quantumLinked = false;
                    });
                    updateAgentList();
                    globeWidget.update();
                    document.getElementById('hud-data').innerText = `Reset | Agents: ${this.agents.length}`;
                } catch (e) {
                    console.error('Reset error:', e);
                    document.getElementById('hud-data').innerText = 'Reset Error';
                }
            }

            async fetchTelemetry(id, task) {
                try {
                    const agent = this.agents.find(a => a.id === id);
                    console.log(`Telemetry for ID ${id}: ${agent.api.endpoint}, Task: ${task}`);
                    return { status: 'Success' };
                } catch (e) {
                    console.error('Fetch telemetry error:', e);
                    return { status: 'Error' };
                }
            }

            async fetchIoT(id) {
                try {
                    const agent = this.agents.find(a => a.id === id);
                    if (agent.iotDeviceId) {
                        console.log(`IoT data for device ${agent.iotDeviceId}`);
                        return { status: 'Connected' };
                    }
                } catch (e) {
                    console.error('Fetch IoT error:', e);
                    return { status: 'Error' };
                }
            }

            async fetchData(id) {
                try {
                    const agent = this.agents.find(a => a.id === id);
                    if (agent.api.endpoint && agent.api.key) {
                        console.log(`Data for ID ${id}: ${agent.api.endpoint}`);
                        return { status: 'Success', dataPayload: { value: Math.random() * 100 } };
                    }
                } catch (e) {
                    console.error('Fetch data error:', e);
                    return { status: 'Error' };
                }
            }

            openConfig(id) {
                try {
                    const agent = this.agents.find(a => a.id === id);
                    document.getElementById('modal-agent-id').innerText = id;
                    document.getElementById('agent-role').value = agent.role;
                    document.getElementById('agent-task').value = agent.task;
                    document.getElementById('api-endpoint').value = agent.api.endpoint;
                    document.getElementById('api-key').value = agent.api.key;
                    document.getElementById('iot-id').value = agent.iotDeviceId;
                    document.getElementById('altitude-target').value = agent.targetAltitude;
                    document.getElementById('speed-target').value = agent.targetSpeed;
                    document.getElementById('config-modal').style.display = 'block';
                    document.getElementById('modal-overlay').style.display = 'block';
                } catch (e) {
                    console.error('Open config error:', e);
                    document.getElementById('hud-data').innerText = 'Config Error';
                }
            }

            saveConfig() {
                try {
                    const id = parseInt(document.getElementById('modal-agent-id').innerText);
                    const agent = this.agents.find(a => a.id === id);
                    agent.role = document.getElementById('agent-role').value;
                    agent.task = document.getElementById('agent-task').value;
                    agent.status = agent.task === 'None' ? 'Idle' : `Exec ${agent.task}`;
                    agent.api.endpoint = document.getElementById('api-endpoint').value;
                    agent.api.key = document.getElementById('api-key').value;
                    agent.iotDeviceId = document.getElementById('iot-id').value;
                    agent.targetAltitude = parseFloat(document.getElementById('altitude-target').value) || 0;
                    agent.targetSpeed = parseFloat(document.getElementById('speed-target').value) || 0;
                    agent.velocity.v = agent.task === 'None' ? 0 : agent.targetSpeed / 3600;
                    if (agent.role === 'Satellite') {
                        agent.orbit.a = 6371 + agent.targetAltitude;
                        agent.orbit.e = 0.01 + Math.random() * 0.02;
                    }
                    if (agent.quantumLinked && agent.task !== 'None') {
                        this.agents.forEach(other => {
                            if (other.id !== id) {
                                other.task = agent.task;
                                other.status = agent.status;
                                other.velocity.v = agent.velocity.v;
                            }
                        });
                    }
                    if (!simulatorMode && (agent.role === 'Satellite' || agent.role === 'Rover') && agent.api.endpoint && agent.api.key) {
                        this.fetchData(id);
                    }
                    closeModal('config-modal');
                    this.testConfig(id);
                    updateAgentList();
                } catch (e) {
                    console.error('Save config error:', e);
                    document.getElementById('hud-data').innerText = 'Config Error';
                }
            }

            async testConfig(id = parseInt(document.getElementById('modal-agent-id').innerText)) {
                try {
                    const agent = this.agents.find(a => a.id === id);
                    const valid = !!agent.api.endpoint && !!agent.api.key;
                    this.apiConnections[id] = { valid };
                    updateAgentList();
                    document.getElementById('hud-data').innerText = valid ? `API Valid | Agents: ${this.agents.length}` : `API Invalid | Agents: ${this.agents.length}`;
                } catch (e) {
                    console.error('Test config error:', e);
                    document.getElementById('hud-data').innerText = 'API Test Error';
                }
            }
        }

        const missionControl = new MissionControl();

        class GlobeWidget {
            constructor() {
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.modalScene = null;
                this.modalCamera = null;
                this.modalRenderer = null;
                this.controls = null;
                this.isModalOpen = false;
                this.lastRenderTime = 0;
                this.resizeTimeout = null;
                this.globeGeometry = new THREE.SphereGeometry(1.2, 16, 16);
                this.globeMaterial = new THREE.MeshBasicMaterial({ color: 0x39FF14, wireframe: true });
                this.markerGeometry = new THREE.SphereGeometry(0.04, 8, 8);
                this.dashMaterial = new THREE.LineDashedMaterial({ color: 0x39FF14, dashSize: 0.1, gapSize: 0.1 });
            }

            initMainGlobe() {
                try {
                    this.scene = new THREE.Scene();
                    this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / clamp(100, 25 * window.innerWidth / 100, 120), 0.1, 1000);
                    this.renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: 'low-power' });
                    this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
                    const width = Math.min(window.innerWidth - 8, 500);
                    const height = clamp(100, 25 * window.innerWidth / 100, 120);
                    this.renderer.setSize(width, height);
                    document.getElementById('globe-widget').appendChild(this.renderer.domElement);
                    const globe = new THREE.Mesh(this.globeGeometry, this.globeMaterial);
                    this.scene.add(globe);
                    this.camera.position.z = 3;
                    this.update();
                    this.renderer.domElement.addEventListener('touchstart', e => e.preventDefault(), { passive: false });
                } catch (e) {
                    console.error('Main Globe init error:', e);
                    document.getElementById('hud-data').innerText = 'Globe Error';
                }
            }

            initModalGlobe() {
                try {
                    this.modalScene = new THREE.Scene();
                    this.modalCamera = new THREE.PerspectiveCamera(75, 600 / 600 * 0.8, 0.1, 1000);
                    this.modalRenderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: 'low-power' });
                    this.modalRenderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
                    const modalWidth = Math.min(window.innerWidth * 0.95, 600);
                    const modalHeight = Math.min(window.innerHeight * 0.9 * 0.8, 600 * 0.8);
                    this.modalRenderer.setSize(modalWidth, modalHeight);
                    document.getElementById('globe-modal-canvas').appendChild(this.modalRenderer.domElement);
                    const modalGlobe = new THREE.Mesh(this.globeGeometry, this.globeMaterial);
                    this.modalScene.add(modalGlobe);
                    this.controls = new THREE.OrbitControls(this.modalCamera, this.modalRenderer.domElement);
                    this.controls.enableZoom = true;
                    this.controls.enablePan = false;
                    this.controls.enableRotate = true;
                    this.controls.rotateSpeed = 0.4;
                    this.controls.minDistance = 1.5;
                    this.controls.maxDistance = 6;
                    this.controls.zoomSpeed = 0.9;
                    this.modalCamera.position.z = 3.5;
                    this.controls.target.set(0, 0, 0);
                    this.update(true, 'all');
                    this.modalRenderer.domElement.addEventListener('touchstart', e => e.preventDefault(), { passive: false });
                } catch (e) {
                    console.error('Modal Globe init error:', e);
                    document.getElementById('hud-data').innerText = 'Modal Error';
                }
            }

            update(isModal = false, selectedAgentId = 'all') {
                try {
                    const scene = isModal ? this.modalScene : this.scene;
                    const camera = isModal ? this.modalCamera : this.camera;
                    const renderer = isModal ? this.modalRenderer : this.renderer;
                    const radius = 1.2;
                    scene.children = [scene.children[0]];
                    const agentsToShow = selectedAgentId === 'all' ? missionControl.agents : missionControl.agents.filter(a => a.id === parseInt(selectedAgentId));
                    agentsToShow.forEach(agent => {
                        const phi = (90 - agent.location.lat) * Math.PI / 180;
                        const theta = (agent.location.lng + 180) * Math.PI / 180;
                        const altScale = agent.role === 'Rover' ? 0 : agent.location.alt / 10000;
                        const x = (radius + altScale) * Math.sin(phi) * Math.cos(theta);
                        const y = (radius + altScale) * Math.cos(phi);
                        const z = (radius + altScale) * Math.sin(phi) * Math.sin(theta);
                        const marker = new THREE.Mesh(
                            this.markerGeometry,
                            new THREE.MeshBasicMaterial({
                                color: agent.role === 'Rocket' ? 0xff0000 :
                                       agent.role === 'Drone' ? 0x00ff00 :
                                       agent.role === 'Satellite' ? 0xffff00 :
                                       agent.role === 'Rover' ? 0xffa500 : 0xff4500
                            })
                        );
                        marker.position.set(x, y, z);
                        marker.scale.set(1 + Math.sin(performance.now() / 500) * 0.2, 1 + Math.sin(performance.now() / 500) * 0.2, 1 + Math.sin(performance.now() / 500) * 0.2);
                        scene.add(marker);
                        if (agent.path.length > 1) {
                            const points = agent.path.map(p => {
                                const pPhi = (90 - p.lat) * Math.PI / 180;
                                const pTheta = (p.lng + 180) * Math.PI / 180;
                                const pAltScale = p.alt / 10000;
                                return new THREE.Vector3(
                                    (radius + pAltScale) * Math.sin(pPhi) * Math.cos(pTheta),
                                    (radius + pAltScale) * Math.cos(pPhi),
                                    (radius + pAltScale) * Math.sin(pPhi) * Math.sin(pTheta)
                                );
                            });
                            const curve = new THREE.CatmullRomCurve3(points);
                            const geometry = new THREE.BufferGeometry().setFromPoints(curve.getPoints(50));
                            const material = new THREE.LineBasicMaterial({ color: 0x39FF14, linewidth: isModal ? 1.5 : 1 });
                            const line = new THREE.Line(geometry, material);
                            scene.add(line);
                        }
                        if (agent.velocity.v > 0) {
                            const predPoints = [];
                            let predLat = agent.location.lat;
                            let predLng = agent.location.lng;
                            let predAlt = agent.location.alt;
                            for (let t = 0; t < 10; t += 0.5) {
                                predLat += agent.velocity.lat * t;
                                predLng += agent.velocity.lng * t;
                                predAlt += agent.role === 'Rocket' ? agent.velocity.v * t * 100 : 0;
                                const pPhi = (90 - predLat) * Math.PI / 180;
                                const pTheta = (predLng + 180) * Math.PI / 180;
                                const pAltScale = predAlt / 10000;
                                predPoints.push(new THREE.Vector3(
                                    (radius + pAltScale) * Math.sin(pPhi) * Math.cos(pTheta),
                                    (radius + pAltScale) * Math.cos(pPhi),
                                    (radius + pAltScale) * Math.sin(pPhi) * Math.sin(pTheta)
                                ));
                            }
                            const predGeometry = new THREE.BufferGeometry().setFromPoints(predPoints);
                            const predLine = new THREE.Line(predGeometry, this.dashMaterial);
                            predLine.computeLineDistances();
                            scene.add(predLine);
                        }
                    });
                    renderer.render(scene, camera);
                } catch (e) {
                    console.error('Update globe error:', e);
                    document.getElementById('hud-data').innerText = 'Marker Error';
                }
            }

            zoom(direction) {
                try {
                    if (this.controls && this.modalCamera) {
                        const currentDistance = this.modalCamera.position.distanceTo(this.modalScene.children[0].position);
                        const newDistance = currentDistance * (direction > 0 ? 0.9 : 1.1);
                        if (newDistance >= this.controls.minDistance && newDistance <= this.controls.maxDistance) {
                            this.modalCamera.position.multiplyScalar(newDistance / currentDistance);
                            this.controls.update();
                            const segments = newDistance < 2.5 ? 64 : newDistance < 4 ? 32 : 16;
                            this.modalScene.children[0].geometry = new THREE.SphereGeometry(1.2, segments, segments);
                            this.update(true, document.getElementById('agent-select').value);
                        }
                    }
                } catch (e) {
                    console.error('Zoom error:', e);
                    document.getElementById('hud-data').innerText = 'Zoom Error';
                }
            }

            focusAgent(agentId) {
                try {
                    this.update(true, agentId);
                    if (agentId === 'all') {
                        this.modalCamera.position.set(0, 0, 3.5);
                    } else {
                        const agent = missionControl.agents.find(a => a.id === parseInt(agentId));
                        if (agent) {
                            const phi = (90 - agent.location.lat) * Math.PI / 180;
                            const theta = (agent.location.lng + 180) * Math.PI / 180;
                            const altScale = agent.role === 'Rover' ? 0 : agent.location.alt / 10000;
                            const radius = 1.2 + altScale + 0.2;
                            this.modalCamera.position.set(
                                radius * Math.sin(phi) * Math.cos(theta),
                                radius * Math.cos(phi),
                                radius * Math.sin(phi) * Math.sin(theta)
                            );
                        }
                    }
                    this.controls.target.set(0, 0, 0);
                    this.controls.update();
                    this.modalRenderer.render(this.modalScene, this.modalCamera);
                } catch (e) {
                    console.error('Focus agent error:', e);
                    document.getElementById('hud-data').innerText = 'Focus Error';
                }
            }

            animate() {
                try {
                    requestAnimationFrame(() => this.animate());
                    const now = performance.now();
                    if (now - this.lastRenderTime < 16 || isPaused) return;
                    this.lastRenderTime = now;
                    if (this.scene && this.camera && this.renderer) {
                        this.scene.children[0].rotation.y += 0.001;
                        this.renderer.render(this.scene, this.camera);
                    }
                    if (this.isModalOpen && this.modalScene && this.modalCamera && this.modalRenderer) {
                        this.controls.update();
                        this.modalRenderer.render(this.modalScene, this.modalCamera);
                    }
                } catch (e) {
                    console.error('Globe animation error:', e);
                    document.getElementById('hud-data').innerText = 'Animation Error';
                }
            }

            openModal() {
                try {
                    this.initModalGlobe();
                    this.isModalOpen = true;
                    document.getElementById('globe-modal').style.display = 'block';
                    document.getElementById('modal-overlay').style.display = 'block';
                    document.getElementById('agent-select').value = 'all';
                    this.resizeModal();
                } catch (e) {
                    console.error('Open modal error:', e);
                    document.getElementById('hud-data').innerText = 'Modal Error';
                }
            }

            closeModal() {
                try {
                    this.isModalOpen = false;
                    document.getElementById('globe-modal').style.display = 'none';
                    document.getElementById('modal-overlay').style.display = 'none';
                    if (this.modalRenderer) {
                        this.modalRenderer.domElement.remove();
                        this.modalRenderer = null;
                    }
                } catch (e) {
                    console.error('Close modal error:', e);
                    document.getElementById('hud-data').innerText = 'Close Modal Error';
                }
            }

            resizeMain() {
                try {
                    if (this.scene && this.camera && this.renderer) {
                        const width = Math.min(window.innerWidth - 8, 500);
                        const height = clamp(height 100, 25 * width / 100, 120);
                        this.renderer.setSize(width, height);
                        this.camera.aspect = width / height;
                        this.camera.updateProjectionMatrix();
                        this.update();
                    }
                } catch (e) {
                    console.error('Resize main error:', e);
                    document.getElementById('hud-data').innerText = 'Resize Error';
                }
            }

            resizeModal() {
                try {
                    if (this.isModalOpen || !this.modalRenderer) return;
                    const modalWidth = Math.min(window.innerWidth * 0.95, 600);
                    const modalHeight = Math.min(window.innerHeight * 0.9 * 0.8, 600 * 0.8);
                    this.modalRenderer.setSize(modalWidth, modalHeight);
                    this.modalCamera.aspect = modalWidth / modalHeight;
                    this.modalCamera.updateProjectionMatrix();
                    this.update(true, document.getElementById('agent-select').value));
                } catch (e) {
                    console.error('Resize modal error:', e);
                    document.getElementById('hud-data').innerText = 'Resize Error';
                }
            }
        }

        const globeWidget = new GlobeWidget();

        class MockWebSocket {
            constructor() {
                this.listeners = [];
                if (simulatorMode) {
                    this.simulateData();
                }
            }
            addEventListener(type, callback)) {
                if (type === 'message') {
                    this.listeners.push(callback);
                }
            }
            simulateData() {
                setInterval(() => {
                    try {
                        if (isPaused) return;
                    const data = missionControl.agents.map(agent => {
                        let newLocation = { ...agent.location };
                        let newVelocity = { ...agent.velocity };
                        if (agent.role === 'Satellite' && agent.task === 'Orbit') {
                            const t = performance.now() / 1000;
                            const a = agent.orbit.a;
                            const e = agent.orbit.e;
                            const meanAnomaly = t * Math.sqrt(398600 / (a * a * a));
                            const eccentricAnomaly = meanAnomaly + e * Math.sin(meanAnomaly);
                            const r = a * (1 - e * Math.cos(eccentricAnomaly));
                            newLocation.lat += 0.03 * Math.cos(t);
                            newLocation.lng += 0.15 * (1 + Math.random() * 0.02);
                            newLocation.alt = (r - 6371) * (1 + (Math.random() - 0.5) * 0.01);
                            newVelocity.lat = 0.03 * Math.cos(t);
                            newVelocity.lng = 0.15;
                        } else if (agent.role === 'Rocket' && agent.task === 'Launch') {
                            newLocation.alt += agent.velocity.v * 1000;
                            newLocation.lat += (Math.random() - 0.5) * 0.02);
                            newLocation.lng += (Math.random() - 0.5) * 0.02);
                            newVelocity.v += 0.01 * Math.random();
                        } else if (agent.role === 'Drone' && agent.task === 'Survey') {
                            newLocation.lat += (Math.random() - 0.5) * 0.05);
                            newLocation.lng += (Math.random() - 0.5) * 0.05);
                            newLocation.alt += (Math.random() - 0.5) * 0.1);
                            newVelocity.lat = (Math.random() - 0.5) * 0.05);
                            newVelocity.lng = (Math.random() - 0.5) * 0.05);
                        } else if (agent.role === 'Rover' && agent.task === 'Navigate') {
                            newLocation.lat += (Math.random() - 0.5) * 0.01);
                            newLocation.lng += (Math.random() - 0.5) * 0.01);
                            newVelocity.lat = (Math.random() - 0.5) * 0.01);
                            newVelocity.lng = (Math.random() - 0.5) * 0.01);
                        } else {
                            newLocation.lat += newVelocity.lat;
                            newLocation.lng += newVelocity.lng;
                            newLocation.alt = Math.max(0, newLocation.alt + (Math.random() - 0.5) * agent.targetAltitude * 0.005));
                        }
                        agent.path.push({ ...newLocation });
                        if (agent.path.length > 50) agent.path.shift();
                        agent.location = newLocation;
                        agent.velocity = newVelocity;
                        if ((agent.role === 'Satellite' || agent.role === 'Rover') && agent.api.endpoint && agent.api.key) {
                            missionControl.fetchData(agent.id);
                        }
                        return {
                            id: agent.id,
                            location: newLocation,
                            status: agent.status,
                            task: agent.task,
                            speed: agent.targetSpeed * (0.9 + Math.random() * 0.2))
                        };
                    });
                    this.listeners.forEach(l => l({ data: JSON.stringify(data) }));
                    updateAgentList();
                    globeWidget.update();
                    document.getElementById('hud-data').innerText = `Running | Agents: ${missionControl.agents.length}`;
                    } catch (e) {
                        console.error('Simulate data error:', e);
                        document.getElementById('hud-data').innerText = 'Sim Data Error';
                    }
                }, 1000);
            }
        }

        function initWebSocket() {
            try {
                if (ws) ws.close();
                ws = simulatorMode ? new MockWebSocket() : new WebSocket('ws://your-api-url');
                ws.addEventListener('message', e => {
                    try {
                        const data = JSON.parse(e.data);
                        data.forEach(a => {
                            const agent = missionControl.agents.find(agent => agent.id === a.id);
                            if (agent) {
                                agent.location = a.location;
                                agent.status = a.status;
                                agent.task = a.task || agent.task;
                                agent.velocity = a.velocity || agent.velocity;
                                agent.path.push({ ...agent.location });
                                if (agent.path.length > 50) agent.path.shift();
                                if (a.iotData) agent.iotDeviceId = a.iotData.deviceId;
                                if ((agent.role === 'Satellite' || agent.role === 'Rover') && a.dataPayload) {
                                    console.log(`Data payload for Agent ${agent.id}:`, a.dataPayload);
                                }
                            }
                        });
                        updateAgentList();
                        globeWidget.update();
                    } catch (e) {
                        console.error('WebSocket message error:', e);
                        document.getElementById('hud-data').innerText = 'Data Error';
                    }
                });
                ws.addEventListener('error', () => {
                    console.error('WebSocket error');
                    document.getElementById('hud-data').innerText = 'Connection Error';
                    updateAgentList();
                });
            } catch (e) {
                console.error('WebSocket init error:', e);
                document.getElementById('hud-data').innerText = 'Connection Error';
                updateAgentList();
            }
        }

        function updateAgentList() {
            try {
                const panel = document.getElementById('agent-panel');
                panel.innerHTML = missionControl.agents.map(a => `
                    <div class="agent-widget">
                        <div class="agent-data">
                            <div>A${a.id}: ${a.role} | ${a.status}</div>
                            <div>L:${a.location.lat.toFixed(1)},${a.location.lng.toFixed(1)} A:${a.location.alt.toFixed(0)}km S:${a.targetSpeed.toFixed(0)}km/h</div>
                        </div>
                        <div class="agent-controls">
                            <select onchange="missionControl.setTask(${a.id}, this.value)" ${!simulatorMode && !missionControl.apiConnections[a.id]?.valid ? 'disabled' : ''}>
                                <option value="None">None</option>
                                <option value="Launch">Launch</option>
                                <option value="Orbit">Orbit</option>
                                <option value="Hold">Hold</option>
                                <option value="Survey">Survey</option>
                                <option value="Return">Return</option>
                                <option value="Land">Land</option>
                                <option value="Navigate">Navigate</option>
                            </select>
                            <input type="checkbox" onchange="missionControl.toggleQuantum(${a.id})" ${a.quantumLinked ? 'checked' : ''} ${!simulatorMode && !missionControl.apiConnections[a.id]?.valid ? 'disabled' : ''}>
                            <button onclick="missionControl.openConfig(${a.id})">Cfg</button>
                        </div>
                    </div>
                `).join('');
                const isConnected = missionControl.agents.every(a => simulatorMode || missionControl.apiConnections[a.id]?.valid);
                document.getElementById('launch-seq').disabled = !simulatorMode && !isConnected;
                if (!isPaused) document.getElementById('hud-data').innerText = simulatorMode ? `Sim Mode | Agents: ${missionControl.agents.length}` : (isConnected ? `API On | Agents: ${missionControl.agents.length}` : `API Off | Agents: ${missionControl.agents.length}`);
            } catch (e) {
                console.error('Update agent list error:', e);
                document.getElementById('hud-data').innerText = 'UI Error';
            }
        }

        function toggleSimulator() {
            try {
                simulatorMode = !simulatorMode;
                initWebSocket();
                updateAgentList();
                document.getElementById('hud-data').innerText = simulatorMode ? `Sim Mode | Agents: ${missionControl.agents.length}` : `API Mode | Agents: ${missionControl.agents.length}`;
            } catch (e) {
                console.error('Toggle simulator error:', e);
                document.getElementById('hud-data').innerText = 'Sim Toggle Error';
            }
        }

        function toggleHUD() {
            try {
                const hud = document.getElementById('hud');
                const toggle = document.getElementById('hud-toggle');
                if (hud.style.height === '0px' || !hud.style.height) {
                    hud.style.height = 'auto';
                    toggle.innerText = '▼';
                } else {
                    hud.style.height = '0px';
                    hud.style.overflow = 'hidden';
                    toggle.innerText = '▲';
                }
            } catch (e) {
                console.error('Toggle HUD error:', e);
                document.getElementById('hud-data').innerText = 'HUD Error';
            }
        }

        function closeModal(modalId) {
            try {
                document.getElementById(modalId).style.display = 'none';
                document.getElementById('modal-overlay').style.display = 'none';
                if (modalId === 'globe-modal') {
                    globeWidget.closeModal();
                }
            } catch (e) {
                console.error('Close modal error:', e);
                document.getElementById('hud-data').innerText = 'Close Modal Error';
            }
        }

        function clamp(value, min, max) {
            return Math.max(min, Math.min(value, max));
        }

        window.addEventListener('resize', () => {
            try {
                clearTimeout(globeWidget.resizeTimeout);
                globeWidget.resizeTimeout = setTimeout(() => {
                    globeWidget.resizeMain();
                    globeWidget.resizeModal();
                }, 100);
            } catch (e) {
                console.error('Resize error:', e);
                document.getElementById('hud-data').innerText = 'Resize Error';
            }
        });

        async function initialize() {
            try {
                document.getElementById('hud-data').innerText = `Initializing | Agents: ${missionControl.agents.length}`;
                globeWidget.initMainGlobe();
                initWebSocket();
                updateAgentList();
                globeWidget.animate();
                document.getElementById('hud-data').innerText = `Initialized | Agents: ${missionControl.agents.length}`;
            } catch (e) {
                console.error('Initialization error:', e);
                document.getElementById('hud-data').innerText = 'Init Error';
            }
        }

        window.onload = initialize;
    </script>
</body>
</html>
