<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Permissions-Policy" content="clipboard-write=(self)">
    <title>Skulptor3D</title>
    <style>
        body { font-family: monospace; margin: 0; padding: 10px; background: #000; color: #0f0; }
        #console, #error-console, #command-input, #py-input, canvas { border: 1px solid #0f0; background: #000; color: #0f0; }
        #console { width: 100%; height: 200px; overflow-y: auto; padding: 10px; font-size: 14px; }
        #error-console { width: 100%; height: 150px; overflow-y: auto; padding: 10px; font-size: 14px; margin-top: 10px; }
        #input-area { margin-top: 10px; display: flex; flex-direction: column; gap: 10px; }
        #command-input { padding: 10px; font-size: 16px; width: 100%; box-sizing: border-box; }
        #py-popup, #skulptor3d-popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 2px solid #0f0; padding: 15px; z-index: 1000; background: #000; }
        #py-input { width: 100%; height: 250px; font-family: monospace; font-size: 14px; box-sizing: border-box; }
        button { padding: 12px; font-size: 16px; cursor: pointer; width: 100%; box-sizing: border-box; background: #0f0; color: #000; }
        button:hover:not(:disabled) { background: #0c0; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        #close-3d-popup { position: absolute; top: 5px; right: 5px; font-weight: bold; padding: 8px; font-size: 14px; background: #f00; color: #fff; }
        #close-3d-popup:hover { background: #c00; }
        #mode-selector { margin-top: 10px; width: 100%; padding: 10px; border: 1px solid #0f0; font-size: 16px; box-sizing: border-box; background: #000; }
        #status-area { margin-bottom: 10px; }
        @media (min-width: 768px) {
            #input-area { flex-direction: row; }
            button { width: auto; }
            #command-input { width: 70%; }
            #mode-selector { width: auto; }
        }
        .log-info { color: #0f0; }
        .log-error { color: #f00; }
        .log-warning { color: #ff0; }
        #log-output { display: none; margin-top: 10px; width: 100%; height: 100px; font-family: monospace; }
        .hidden { display: none; }
    </style>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.0/full/pyodide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gl-matrix/2.8.1/gl-matrix-min.js"></script>
</head>
<body>
    <div id="console" class="border" role="log" aria-live="polite"></div>
    <div id="error-console" class="border" role="log" aria-live="assertive"></div>
    <button id="copy-log-btn" disabled aria-label="Copy error log to clipboard">Copy Log</button>
    <div id="status-area">
        <span id="pyodide-status">Loading...</span> |
        <span id="webgpu-status">Checking...</span> |
        <span id="fps">0.00</span> FPS | <span id="memory">0.00</span> MB
    </div>
    <select id="game-mode" class="border bg-transparent" aria-label="Select game mode">
        <option value="3d">3D Mode</option>
        <option value="mars-trails">Mars Trails</option>
    </select>
    <div id="input-area" class="flex flex-col md:flex-row gap-2">
        <input id="command-input" type="text" placeholder="Enter command" class="border" aria-label="Enter Python command">
        <button id="execute-btn" disabled aria-label="Execute command">Execute</button>
        <button id="inject-btn" disabled aria-label="Open Python code input popup">Inject</button>
        <button id="close-btn" disabled aria-label="Close Python code input popup">Close</button>
        <button id="troubleshoot-btn" disabled aria-label="Run troubleshooting diagnostics">Troubleshoot</button>
    </div>
    <div id="py-popup" class="hidden">
        <textarea id="py-input" placeholder="Paste Python/Skulptor3D code" class="border" aria-label="Python code input"></textarea><br>
        <button onclick="injectScript()" class="mt-2" aria-label="Inject Python code">Inject</button>
        <button onclick="closePopup()" class="mt-2" aria-label="Close Python code popup">Close</button>
    </div>
    <div id="skulptor3d-popup" class="hidden">
        <button id="close-3d-popup" onclick="close3DPopup()" aria-label="Close 3D canvas popup">X</button>
        <canvas id="skulptor3d-canvas" aria-label="3D rendering canvas"></canvas>
    </div>
    <textarea id="log-output" readonly placeholder="Error log for manual copy" aria-label="Error log output"></textarea>
    <script>
        let pyodide;
        let pyodideReady = false;
        let skulptor3dAvailable = false;
        let globalErrorLog = [];
        let glContext = null;
        let renderLoopRunning = false;

        function addToErrorLog(level, message) {
            globalErrorLog.push({timestamp: new Date().toISOString(), level, message});
            if (globalErrorLog.length > 100) globalErrorLog.shift();
            document.getElementById('error-console').innerHTML += `<div class="log-${level.toLowerCase()}">[${level}] ${message}</div>`;
            document.getElementById('error-console').scrollTop = document.getElementById('error-console').scrollHeight;
        }

        async function loadPyodideWithFallback() {
            try {
                document.getElementById('console').innerHTML += '<div class="log-info">[INFO] Loading Pyodide...</div>';
                pyodide = await loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.26.0/full/' });
                document.getElementById('console').innerHTML += '<div class="log-info">[INFO] Pyodide loaded successfully</div>';
                return true;
            } catch (e) {
                addToErrorLog('ERROR', `${e.message}. Retrying...`);
                return await tryPyodideWorkaround();
            }
        }

        async function tryPyodideWorkaround() {
            try {
                const script = document.createElement('script');
                script.src = `https://cdn.jsdelivr.net/pyodide/v0.26.0/full/pyodide.js?t=${Date.now()}`;
                script.async = false;
                document.head.appendChild(script);
                await new Promise((resolve, reject) => {
                    script.onload = () => resolve();
                    script.onerror = () => reject(new Error('Failed to reload pyodide.js'));
                });
                document.getElementById('console').innerHTML += '<div class="log-info">[INFO] Pyodide script reloaded, initializing...</div>';
                pyodide = await loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.26.0/full/' });
                document.getElementById('console').innerHTML += '<div class="log-info">[INFO] Pyodide workaround successful</div>';
                return true;
            } catch (e) {
                addToErrorLog('ERROR', `Workaround failed: ${e.message}`);
                return false;
            }
        }

        async function checkSkulptor3D() {
            try {
                await pyodide.runPythonAsync(`
                    import js
                    from pyodide.ffi import create_proxy
                    class Skulptor3D:
                        def __init__(self):
                            self.canvas = js.document.getElementById("skulptor3d-canvas")
                            self.shapes = []
                        def add_cube(self, position=(0, 0, 0), size=1):
                            self.shapes.append({"type": "cube", "position": position, "size": size})
                            js.console.log(f"Added cube at {position} with size {size}")
                        async def test_suite(self):
                            js.document.getElementById("console").innerHTML += '<div class="log-info">[INFO] Skulptor3D test suite passed</div>'
                        def agent_scan(self, section):
                            return f"Scanned {section}: OK"
                    globals()['Skulptor3D'] = Skulptor3D
                `);
                skulptor3dAvailable = true;
                document.getElementById('console').innerHTML += '<div class="log-info">[INFO] Skulptor3D module available</div>';
            } catch (e) {
                skulptor3dAvailable = false;
                addToErrorLog('WARNING', 'Skulptor3D module not found. Using mock implementation.');
            }
        }

        async function initPyodide() {
            try {
                document.getElementById('console').innerHTML += '<div class="log-info">[INFO] Initializing Pyodide...</div>';
                const loaded = await loadPyodideWithFallback();
                if (!loaded) {
                    throw new Error('Pyodide initialization failed after retry attempts.');
                }
                await checkSkulptor3D();
                document.getElementById('console').innerHTML += '<div class="log-info">[INFO] Pyodide initialized</div>';
                pyodideReady = true;
                document.getElementById('pyodide-status').textContent = 'Loaded';
                ['execute-btn', 'inject-btn', 'close-btn', 'troubleshoot-btn', 'copy-log-btn'].forEach(id => {
                    document.getElementById(id).disabled = false;
                });
                initWebGL();
                updatePerformance();
            } catch (e) {
                addToErrorLog('ERROR', `Pyodide init failed: ${e.message}`);
                document.getElementById('pyodide-status').textContent = 'Failed';
                disableInteractiveFeatures();
            }
        }

        function disableInteractiveFeatures() {
            ['execute-btn', 'inject-btn', 'close-btn', 'troubleshoot-btn', 'copy-log-btn'].forEach(id => {
                document.getElementById(id).disabled = true;
            });
        }

        function initWebGL() {
            const canvas = document.getElementById('skulptor3d-canvas');
            glContext = canvas.getContext('webgl') || canvas.getContext('webgl2');
            if (glContext) {
                document.getElementById('webgpu-status').textContent = 'WebGL';
                document.getElementById('console').innerHTML += '<div class="log-info">[INFO] WebGL supported</div>';
                startRenderLoop();
            } else {
                document.getElementById('webgpu-status').textContent = 'Not Supported';
                addToErrorLog('ERROR', 'Neither WebGPU nor WebGL supported');
            }
        }

        function startRenderLoop() {
            if (renderLoopRunning) return;
            renderLoopRunning = true;
            const gl = glContext;
            gl.clearColor(0.0, 0.0, 0.0, 1.0);
            gl.enable(gl.DEPTH_TEST);
            function render() {
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                // Placeholder for rendering shapes from Skulptor3D
                requestAnimationFrame(render);
            }
            requestAnimationFrame(render);
        }

        function updatePerformance() {
            let lastTime = performance.now();
            let frameCount = 0;
            function loop(currentTime) {
                frameCount++;
                const delta = currentTime - lastTime;
                if (delta >= 1000) {
                    const fps = (frameCount * 1000 / delta).toFixed(2);
                    document.getElementById('fps').textContent = fps;
                    if (performance.memory) {
                        const memory = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(2);
                        document.getElementById('memory').textContent = memory;
                    }
                    frameCount = 0;
                    lastTime = currentTime;
                }
                requestAnimationFrame(loop);
            }
            requestAnimationFrame(loop);
        }

        function showPopup() {
            if (!pyodideReady) {
                addToErrorLog('ERROR', 'Pyodide not ready');
                return;
            }
            document.getElementById('py-popup').style.display = 'block';
        }

        function closePopup() {
            document.getElementById('py-popup').style.display = 'none';
            document.getElementById('py-input').value = '';
        }

        function show3DPopup() {
            document.getElementById('skulptor3d-popup').style.display = 'block';
            resizeCanvas();
        }

        function close3DPopup() {
            document.getElementById('skulptor3d-popup').style.display = 'none';
        }

        async function executeCommand() {
            if (!pyodideReady) {
                addToErrorLog('ERROR', 'Pyodide not ready');
                return;
            }
            const cmd = document.getElementById('command-input').value.trim();
            try {
                if (cmd === '/test') {
                    if (!skulptor3dAvailable) {
                        throw new Error('Skulptor3D module not available');
                    }
                    await pyodide.runPythonAsync(`
                        from js import document
                        await Skulptor3D().test_suite()
                    `);
                } else if (cmd === '/show3d') {
                    show3DPopup();
                } else {
                    await pyodide.runPythonAsync(cmd);
                }
                document.getElementById('console').innerHTML += `<div class="log-info">[INFO] Command executed successfully</div>`;
            } catch (err) {
                addToErrorLog('ERROR', err.message);
            }
            document.getElementById('command-input').value = '';
            document.getElementById('console').scrollTop = document.getElementById('console').scrollHeight;
        }

        async function injectScript() {
            if (!pyodideReady) {
                addToErrorLog('ERROR', 'Pyodide not ready');
                return;
            }
            const code = document.getElementById('py-input').value.trim();
            if (!code) {
                document.getElementById('console').innerHTML += '<div class="log-warning">[WARNING] No code to inject</div>';
                return;
            }
            try {
                await pyodide.runPythonAsync(code);
                document.getElementById('console').innerHTML += '<div class="log-info">[INFO] Script injected successfully</div>';
                closePopup();
            } catch (err) {
                addToErrorLog('ERROR', `🐍 ${err.message}`);
            }
        }

        async function runTroubleshoot() {
            if (!pyodideReady) {
                addToErrorLog('ERROR', 'Pyodide not ready');
                return;
            }
            document.getElementById('console').innerHTML += '<div class="log-info">[INFO] Initiating troubleshooting...</div>';
            if (!skulptor3dAvailable) {
                addToErrorLog('WARNING', 'Skulptor3D module not available. Troubleshooting limited to Pyodide checks.');
                document.getElementById('console').innerHTML += '<div class="log-info">[INFO] Troubleshooting completed</div>';
                return;
            }
            const agents = Array(5).fill().map((_, i) => ({
                id: i,
                section: ['imports', 'utils', 'game', 'render', 'ui'][i]
            }));
            const results = await Promise.all(agents.map(async agent => {
                try {
                    const code = await pyodide.runPythonAsync(`
                        from skulptor3d import Skulptor3D
                        Skulptor3D().agent_scan('${agent.section}')
                    `);
                    return { id: agent.id, section: agent.section, result: code.toString(), status: 'success' };
                } catch (e) {
                    return { id: agent.id, section: agent.section, result: e.message, status: 'error' };
                }
            }));
            results.forEach(result => {
                if (result.status === 'error') {
                    addToErrorLog('ERROR', `[AGENT ${result.id}] ${result.section}: ${result.result}`);
                } else {
                    document.getElementById('console').innerHTML += `<div class="log-info">[AGENT ${result.id}] ${result.section}: Valid</div>`;
                }
            });
            document.getElementById('console').innerHTML += '<div class="log-info">[INFO] Troubleshooting completed</div>';
        }

        async function copyErrorLog() {
            if (!globalErrorLog.length) {
                document.getElementById('console').innerHTML += '<div class="log-info">[INFO] No errors to copy</div>';
                return;
            }
            const logText = globalErrorLog.map(entry => `[${entry.timestamp}] [${entry.level}] ${entry.message}`).join('\n');
            try {
                await navigator.clipboard.writeText(logText);
                document.getElementById('console').innerHTML += '<div class="log-info">[INFO] Error log copied to clipboard</div>';
            } catch (err) {
                addToErrorLog('ERROR', `Clipboard write failed: ${err.message}. Displaying log for manual copy.`);
                const logOutput = document.getElementById('log-output');
                logOutput.value = logText;
                logOutput.style.display = 'block';
            }
        }

        function resizeCanvas() {
            const canvas = document.getElementById('skulptor3d-canvas');
            if (canvas) {
                const dpr = window.devicePixelRatio || 1;
                const width = Math.min(window.innerWidth - 40, 800);
                const height = Math.min(window.innerHeight - 300, 600);
                canvas.width = width * dpr;
                canvas.height = height * dpr;
                canvas.style.width = `${width}px`;
                canvas.style.height = `${height}px`;
                if (glContext) {
                    glContext.viewport(0, 0, canvas.width, canvas.height);
                }
            }
        }

        window.addEventListener('resize', resizeCanvas);
        document.getElementById('execute-btn').onclick = executeCommand;
        document.getElementById('inject-btn').onclick = showPopup;
        document.getElementById('close-btn').onclick = closePopup;
        document.getElementById('troubleshoot-btn').onclick = runTroubleshoot;
        document.getElementById('copy-log-btn').onclick = copyErrorLog;
        initPyodide();
        resizeCanvas();
    </script>
</body>
</html>
