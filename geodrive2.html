<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GeoDrive - WebXOS 2025</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/idb/7.1.1/umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Courier New', monospace;
    }
    body {
      background: #000;
      color: #00ff00;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      text-align: center;
    }
    h1 {
      font-size: 2em;
      text-shadow: 0 0 15px #00ff00;
      margin-bottom: 20px;
    }
    .container {
      max-width: 400px;
      width: 100%;
      padding: 20px;
      border: 2px solid #00ff00;
      border-radius: 10px;
      box-shadow: 0 0 20px #00ff00;
      background: rgba(0, 255, 0, 0.1);
    }
    h2 {
      font-size: 1.5em;
      margin: 15px 0;
      text-shadow: 0 0 10px #00ff00;
    }
    input, button, textarea {
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      background: #111;
      color: #00ff00;
      border: 1px solid #00ff00;
      border-radius: 5px;
      font-size: 1em;
    }
    button {
      cursor: pointer;
      background: #00ff00;
      color: #000;
      font-weight: bold;
      transition: all 0.3s;
    }
    button:hover {
      background: #000;
      color: #00ff00;
      box-shadow: 0 0 10px #00ff00;
    }
    textarea {
      resize: none;
      height: 80px;
    }
    #output {
      margin-top: 10px;
      font-size: 0.9em;
      word-wrap: break-word;
    }
    footer {
      margin-top: 20px;
      font-size: 0.8em;
      text-shadow: 0 0 5px #00ff00;
    }
    @media (max-width: 600px) {
      h1 {
        font-size: 1.6em;
      }
      .container {
        padding: 15px;
      }
      input, button, textarea {
        font-size: 0.85em;
      }
    }
  </style>
</head>
<body>
  <h1>GeoDrive - WebXOS 2025</h1>
  <div class="container">
    <h2>Create Profile</h2>
    <button onclick="createProfile()">Generate Profile Key</button>
    <textarea id="profileKey" readonly placeholder="Your profile key..."></textarea>
    <button onclick="copyProfileKey()">Copy Profile Key</button>
    <h2>Access GeoDrive</h2>
    <textarea id="profileInput" placeholder="Paste profile key to access drive..."></textarea>
    <button onclick="openGeoDrive()">Open GeoDrive</button>
    <div id="output"></div>
  </div>
  <footer>© 2025 WebXOS. All rights reserved.</footer>

  <script>
    // Initialize IndexedDB
    const dbPromise = idb.openDB('GeoDriveDB', 1, {
      upgrade(db) {
        db.createObjectStore('profiles', { keyPath: 'profileKey' });
        db.createObjectStore('data', { keyPath: 'dataKey' });
      }
    });

    // Create profile key
    async function createProfile() {
      const profileKeyOutput = document.getElementById('profileKey');
      const output = document.getElementById('output');
      try {
        const randomStr = CryptoJS.lib.WordArray.random(16).toString();
        const profileKey = `GEO_${randomStr.slice(0, 8)}-${randomStr.slice(8, 16)}-${randomStr.slice(16, 24)}`;
        const db = await dbPromise;
        await db.put('profiles', { profileKey, size: 0.001 }); // Negligible size
        profileKeyOutput.value = profileKey;
        output.textContent = 'Profile key generated!';
      } catch (err) {
        output.textContent = `Error: ${err.message}`;
      }
    }

    // Copy profile key
    function copyProfileKey() {
      const profileKey = document.getElementById('profileKey').value;
      const output = document.getElementById('output');
      if (!profileKey) {
        output.textContent = 'Error: No profile key to copy.';
        return;
      }
      navigator.clipboard.writeText(profileKey).then(() => {
        output.textContent = 'Profile key copied to clipboard!';
      }).catch(err => {
        output.textContent = `Error: ${err.message}`;
      });
    }

    // Open GeoDrive popup
    async function openGeoDrive() {
      const profileKey = document.getElementById('profileInput').value.trim();
      const output = document.getElementById('output');
      if (!profileKey) {
        output.textContent = 'Error: Please enter a profile key.';
        return;
      }

      try {
        const db = await dbPromise;
        const profile = await db.get('profiles', profileKey);
        if (!profile) {
          output.textContent = 'Error: Invalid profile key.';
          return;
        }

        const dataItems = await db.getAll('data');
        const userData = dataItems.filter(d => d.profileKey === profileKey);

        // Browser detection for storage limits
        const ua = navigator.userAgent.toLowerCase();
        const browser = {
          chrome: /chrome|chromium|crios/.test(ua),
          firefox: /firefox|fxios/.test(ua),
          safari: /safari/.test(ua) && !/chrome|chromium|crios/.test(ua),
        };
        const MAX_PER_KEY_MB = browser.chrome || browser.firefox ? 1000 : browser.safari ? 500 : 500;
        const MAX_TOTAL_MB = 1000000; // 1TB
        let totalUsedMB = 0.001; // Profile size
        userData.forEach(d => totalUsedMB += d.size || 0);

        // Popup HTML
        const popupHTML = `
          <!DOCTYPE html>
          <html>
          <head>
            <title>GeoDrive - Your Data</title>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/idb/7.1.1/umd.min.js"></script>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Courier New', monospace; }
              body { background: #000; color: #00ff00; padding: 20px; text-align: center; }
              h1 { font-size: 1.8em; text-shadow: 0 0 10px #00ff00; margin-bottom: 20px; }
              h2 { font-size: 1.5em; margin: 15px 0; text-shadow: 0 0 10px #00ff00; }
              .container { max-width: 600px; margin: auto; padding: 20px; border: 2px solid #00ff00; border-radius: 10px; box-shadow: 0 0 20px #00ff00; background: rgba(0, 255, 0, 0.1); }
              input, button, textarea { width: 100%; margin: 10px 0; padding: 10px; background: #111; color: #00ff00; border: 1px solid #00ff00; border-radius: 5px; font-size: 1em; }
              button { cursor: pointer; background: #00ff00; color: #000; font-weight: bold; transition: all 0.3s; }
              button:hover { background: #000; color: #00ff00; box-shadow: 0 0 10px #00ff00; }
              textarea { resize: vertical; min-height: 100px; }
              #output, #storageInfo { margin-top: 10px; font-size: 0.9em; word-wrap: break-word; }
              table { width: 100%; border-collapse: collapse; margin: 10px 0; }
              th, td { border: 1px solid #00ff00; padding: 8px; text-align: left; font-size: 0.9em; }
              th { background: #00ff00; color: #000; }
              pre { background: #111; padding: 10px; border: 1px solid #00ff00; }
              @media (max-width: 600px) { h1 { font-size: 1.5em; } .container { padding: 15px; } input, button, textarea, th, td { font-size: 0.85em; } }
            </style>
          </head>
          <body>
            <h1>GeoDrive - Your Data</h1>
            <div class="container">
              <h2>Store Data</h2>
              <textarea id="textInput" placeholder="Enter text to store..."></textarea>
              <input type="file" id="fileInput" accept="*/*">
              <button onclick="storeData('${profileKey}')">Store Text/File</button>
              <textarea id="dataKey" readonly placeholder="Generated data key..."></textarea>
              <button onclick="copyDataKey()">Copy Data Key</button>
              <h2>Manage Keys</h2>
              <div id="storageInfo">
                Browser: ${browser.chrome ? 'Chrome' : browser.firefox ? 'Firefox' : browser.safari ? 'Safari' : 'Unknown'}<br>
                Max per key: ${MAX_PER_KEY_MB} MB<br>
                Total used: ${totalUsedMB.toFixed(3)} MB<br>
                Remaining: ${(MAX_TOTAL_MB - totalUsedMB).toFixed(3)} MB of ${MAX_TOTAL_MB} MB
              </div>
              <table id="keyTable">
                <thead><tr><th>Type</th><th>Key</th><th>Size (MB)</th><th>Action</th></tr></thead>
                <tbody>
                  <tr>
                    <td>Profile</td>
                    <td>${profileKey}</td>
                    <td>0.001</td>
                    <td><button onclick="deleteKey('profiles', '${profileKey}')">Delete</button></td>
                  </tr>
                  ${userData.map(d => `
                    <tr>
                      <td>Data</td>
                      <td>${d.dataKey}</td>
                      <td>${d.size.toFixed(3)}</td>
                      <td>
                        ${d.isText ?
                          `<button onclick="document.getElementById('text-${d.dataKey}').style.display='block'">View</button>
                           <pre id="text-${d.dataKey}" style="display:none">${decryptData(d.encryptedData, profileKey)}</pre>` :
                          `<button onclick="downloadFile('${d.dataKey}', '${d.fileName}', '${profileKey}')">Download</button>`}
                        <button onclick="deleteKey('data', '${d.dataKey}')">Delete</button>
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
              <button onclick="regenerateDB()">Regenerate Database</button>
              <div id="output"></div>
            </div>
            <footer>© 2025 WebXOS. All rights reserved.</footer>
            <script>
              const dbPromise = idb.openDB('GeoDriveDB', 1);
              const MAX_PER_KEY_MB = ${MAX_PER_KEY_MB};
              const MAX_TOTAL_MB = ${MAX_TOTAL_MB};
              let totalUsedMB = ${totalUsedMB};

              function decryptData(encrypted, profileKey) {
                const aesKey = CryptoJS.SHA256(profileKey).toString();
                return CryptoJS.AES.decrypt(encrypted, aesKey).toString(CryptoJS.enc.Utf8);
              }

              async function storeData(profileKey) {
                const textInput = document.getElementById('textInput').value;
                const fileInput = document.getElementById('fileInput').files[0];
                const dataKeyOutput = document.getElementById('dataKey');
                const output = document.getElementById('output');

                if (!textInput && !fileInput) {
                  output.textContent = 'Error: Please enter text or select a file.';
                  return;
                }
                if (totalUsedMB >= MAX_TOTAL_MB) {
                  output.textContent = 'Error: Total storage limit (1TB) reached.';
                  return;
                }

                try {
                  let data, sizeMB, fileName = 'text.txt';
                  if (fileInput) {
                    data = await fileInput.arrayBuffer();
                    sizeMB = data.byteLength / (1024 * 1024);
                    fileName = fileInput.name;
                  } else {
                    data = new TextEncoder().encode(textInput).buffer;
                    sizeMB = data.byteLength / (1024 * 1024);
                  }

                  if (sizeMB > MAX_PER_KEY_MB) {
                    output.textContent = \`Error: Data size (\${sizeMB.toFixed(3)} MB) exceeds per-key limit (\${MAX_PER_KEY_MB} MB).\`;
                    return;
                  }
                  if (totalUsedMB + sizeMB > MAX_TOTAL_MB) {
                    output.textContent = \`Error: Not enough remaining storage (\${(MAX_TOTAL_MB - totalUsedMB).toFixed(3)} MB left).\`;
                    return;
                  }

                  const aesKey = CryptoJS.SHA256(profileKey).toString();
                  const wordArray = CryptoJS.lib.WordArray.create(data);
                  const encrypted = CryptoJS.AES.encrypt(wordArray, aesKey).toString();
                  const dataHash = CryptoJS.SHA256(encrypted).toString();
                  const dataKey = \`GEO_\${dataHash.slice(0, 8)}-\${dataHash.slice(8, 16)}-\${dataHash.slice(16, 24)}\`;

                  const db = await dbPromise;
                  await db.put('data', {
                    dataKey,
                    profileKey,
                    fileName,
                    size: sizeMB,
                    encryptedData: encrypted,
                    isText: !fileInput
                  });

                  totalUsedMB += sizeMB;
                  dataKeyOutput.value = dataKey;
                  output.textContent = \`Data stored! Key: \${dataKey}\`;
                  updateStorageInfo();
                } catch (err) {
                  output.textContent = \`Error: \${err.message}\`;
                }
              }

              function copyDataKey() {
                const dataKey = document.getElementById('dataKey').value;
                const output = document.getElementById('output');
                if (!dataKey) {
                  output.textContent = 'Error: No data key to copy.';
                  return;
                }
                navigator.clipboard.writeText(dataKey).then(() => {
                  output.textContent = 'Data key copied to clipboard!';
                }).catch(err => {
                  output.textContent = \`Error: \${err.message}\`;
                });
              }

              async function downloadFile(dataKey, fileName, profileKey) {
                try {
                  const db = await dbPromise;
                  const data = await db.get('data', dataKey);
                  if (!data) {
                    document.getElementById('output').textContent = 'Error: Invalid data key.';
                    return;
                  }
                  const aesKey = CryptoJS.SHA256(profileKey).toString();
                  const decrypted = CryptoJS.AES.decrypt(data.encryptedData, aesKey);
                  const blob = new Blob([decrypted.toString(CryptoJS.enc.Latin1)], { type: 'application/octet-stream' });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url;
                  a.download = fileName;
                  a.click();
                  URL.revokeObjectURL(url);
                  document.getElementById('output').textContent = \`File "\${fileName}" downloaded!\`;
                } catch (err) {
                  document.getElementById('output').textContent = \`Error: \${err.message}\`;
                }
              }

              async function deleteKey(store, key) {
                const output = document.getElementById('output');
                try {
                  const db = await dbPromise;
                  const item = await db.get(store, key);
                  if (item) {
                    totalUsedMB -= item.size || 0.001;
                    await db.delete(store, key);
                    output.textContent = \`Key \${key} deleted.\`;
                    updateStorageInfo();
                  }
                } catch (err) {
                  output.textContent = \`Error: \${err.message}\`;
                }
              }

              async function regenerateDB() {
                const output = document.getElementById('output');
                try {
                  await idb.deleteDB('GeoDriveDB');
                  const db = await idb.openDB('GeoDriveDB', 1, {
                    upgrade(db) {
                      db.createObjectStore('profiles', { keyPath: 'profileKey' });
                      db.createObjectStore('data', { keyPath: 'dataKey' });
                    }
                  });
                  totalUsedMB = 0;
                  output.textContent = 'Database regenerated!';
                  updateStorageInfo();
                } catch (err) {
                  output.textContent = \`Error: \${err.message}\`;
                }
              }

              async function updateStorageInfo() {
                const db = await dbPromise;
                const profiles = await db.getAll('profiles');
                const dataItems = await db.getAll('data');
                const userData = dataItems.filter(d => d.profileKey === '${profileKey}');
                totalUsedMB = 0.001; // Profile size
                userData.forEach(d => totalUsedMB += d.size || 0);

                const tbody = document.querySelector('#keyTable tbody');
                tbody.innerHTML = `
                  <tr>
                    <td>Profile</td>
                    <td>${profileKey}</td>
                    <td>0.001</td>
                    <td><button onclick="deleteKey('profiles', '${profileKey}')">Delete</button></td>
                  </tr>
                  ${userData.map(d => `
                    <tr>
                      <td>Data</td>
                      <td>\${d.dataKey}</td>
                      <td>\${d.size.toFixed(3)}</td>
                      <td>
                        \${d.isText ?
                          \`<button onclick="document.getElementById('text-\${d.dataKey}').style.display='block'">View</button>
                           <pre id="text-\${d.dataKey}" style="display:none">\${decryptData(d.encryptedData, '${profileKey}')}</pre>\` :
                          \`<button onclick="downloadFile('\${d.dataKey}', '\${d.fileName}', '${profileKey}')">Download</button>\`}
                        <button onclick="deleteKey('data', '\${d.dataKey}')">Delete</button>
                      </td>
                    </tr>
                  `).join('')}
                `;
                document.getElementById('storageInfo').innerHTML = `
                  Browser: ${browser.chrome ? 'Chrome' : browser.firefox ? 'Firefox' : browser.safari ? 'Safari' : 'Unknown'}<br>
                  Max per key: ${MAX_PER_KEY_MB} MB<br>
                  Total used: \${totalUsedMB.toFixed(3)} MB<br>
                  Remaining: \${(MAX_TOTAL_MB - totalUsedMB).toFixed(3)} MB of ${MAX_TOTAL_MB} MB
                `;
              }
            </script>
          </body>
          </html>
        `;
        const popup = window.open('', 'GeoDrive', 'width=600,height=600');
        popup.document.write(popupHTML);
      } catch (err) {
        output.textContent = `Error: ${err.message}`;
      }
    }
  </script>
</body>
</html>
