<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skulptor3D Injector</title>
    <style>
        body {
            font-family: monospace;
            background: #000;
            color: #0f0;
            margin: 10px;
        }
        #console {
            width: 100%;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #0f0;
            padding: 10px;
            background: #000;
            white-space: pre-wrap;
        }
        #input-area {
            margin-top: 10px;
        }
        #command-input {
            width: 100%;
            padding: 5px;
            background: #000;
            color: #0f0;
            border: 1px solid #0f0;
        }
        #py-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            border: 2px solid #0f0;
            padding: 20px;
            z-index: 1000;
        }
        #skulptor3d-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            border: 2px solid #0f0;
            padding: 10px;
            z-index: 1000;
            width: 820px;
            height: 620px;
            resize: both;
            overflow: auto;
        }
        #py-input {
            width: 600px;
            height: 400px;
            background: #000;
            color: #0f0;
            border: 1px solid #0f0;
        }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0c0;
        }
        #close-3d-popup {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #f00;
            color: #fff;
            font-weight: bold;
            padding: 2px 8px;
        }
        #close-3d-popup:hover {
            background: #c00;
        }
        .error-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .error-table th, .error-table td {
            border: 1px solid #0f0;
            padding: 5px;
            text-align: left;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.0/full/pyodide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.141.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt-stdlib.js"></script>
</head>
<body>
    <div id="console"></div>
    <div id="input-area">
        <input id="command-input" type="text" placeholder="Enter command (e.g., import skulptor3d)">
    </div>
    <div id="py-popup">
        <textarea id="py-input" placeholder="Paste Python code here"></textarea><br>
        <button onclick="injectScript()">Inject Script</button>
        <button onclick="closePopup()">Close</button>
    </div>
    <div id="skulptor3d-popup">
        <button id="close-3d-popup" onclick="close3DPopup()">X</button>
        <canvas id="skulptor3d-canvas"></canvas>
    </div>
    <button onclick="showPopup()">Inject Script</button>
    <button onclick="troubleshoot()">Troubleshoot</button>
    <button onclick="downloadErrorLog()">Download Error Log</button>
    <script>
        let pyodide;
        async function initPyodide() {
            try {
                pyodide = await loadPyodide();
                await pyodide.loadPackage(['micropip']);
                await pyodide.runPythonAsync(`
                    import micropip
                    try:
                        await micropip.install(['pdf2image', 'numpy'])
                        print("[INFO] Successfully installed pdf2image and numpy")
                    except Exception as e:
                        print(f"[ERROR] Failed to install dependencies: {str(e)}")
                `);
            } catch (e) {
                document.getElementById('console').innerHTML += `[ERROR] Pyodide initialization failed: ${e} (Stack: ${e.stack || 'Not available'})<br>`;
            }
        }
        initPyodide();

        function showPopup() {
            document.getElementById('py-popup').style.display = 'block';
        }
        function closePopup() {
            document.getElementById('py-popup').style.display = 'none';
        }
        function show3DPopup() {
            document.getElementById('skulptor3d-popup').style.display = 'block';
        }
        function close3DPopup() {
            document.getElementById('skulptor3d-popup').style.display = 'none';
        }
        async function injectScript() {
            const code = document.getElementById('py-input').value;
            Sk.configure({
                output: function(text) {
                    const consoleDiv = document.getElementById('console');
                    consoleDiv.innerHTML += text + '<br>';
                    consoleDiv.scrollTop = consoleDiv.scrollHeight;
                },
                inputfun: function(prompt) {
                    return new Promise(resolve => {
                        const input = window.prompt(prompt);
                        resolve(input);
                    });
                },
                inputfunTakesPrompt: true
            });
            try {
                await pyodide.runPythonAsync(code);
                show3DPopup();
            } catch (err) {
                const consoleDiv = document.getElementById('console');
                consoleDiv.innerHTML += `[ERROR] ${err.toString()} (Stack: ${err.stack || 'Not available'})<br>`;
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
            }
            closePopup();
        }
        async function troubleshoot() {
            const consoleDiv = document.getElementById('console');
            consoleDiv.innerHTML += '[INFO] Running diagnostics...<br>';
            const checks = [
                { name: 'Pyodide Loaded', test: () => typeof pyodide !== 'undefined', fix: 'Ensure Pyodide is loaded via <script src="https://cdn.jsdelivr.net/pyodide/v0.23.0/full/pyodide.js">', line: '85' },
                { name: 'Micropip Loaded', test: () => pyodide.runPython('import micropip; return True'), fix: 'Ensure micropip is loaded via pyodide.loadPackage(["micropip"])', line: '111' },
                { name: 'Skulpt Loaded', test: () => typeof Sk !== 'undefined', fix: 'Include Skulpt scripts in HTML head.', line: '87-88' },
                { name: 'Three.js Loaded', test: () => typeof THREE !== 'undefined', fix: 'Include Three.js script: <script src="https://cdn.jsdelivr.net/npm/three@0.141.0/build/three.min.js">', line: '86' },
                { name: 'Console Div', test: () => !!document.getElementById('console'), fix: 'Ensure <div id="console"> exists in HTML.', line: '94' },
                { name: 'Command Input', test: () => !!document.getElementById('command-input'), fix: 'Ensure <input id="command-input"> exists in HTML.', line: '96' },
                { name: 'Py Popup', test: () => !!document.getElementById('py-popup'), fix: 'Ensure <div id="py-popup"> exists in HTML.', line: '98' },
                { name: '3D Popup', test: () => !!document.getElementById('skulptor3d-popup'), fix: 'Ensure <div id="skulptor3d-popup"> exists in HTML.', line: '101' },
                { name: 'Canvas', test: () => !!document.getElementById('skulptor3d-canvas'), fix: 'Ensure <canvas id="skulptor3d-canvas"> exists in 3D popup.', line: '103' },
                { name: 'WebGPU Support', test: () => !!navigator.gpu, fix: 'Use Chrome 113+ or Edge with WebGPU enabled (chrome://flags).', line: '' },
                { name: 'WebGL Support', test: () => !!document.createElement('canvas').getContext('webgl'), fix: 'Ensure browser supports WebGL.', line: '' }
            ];
            let table = '<table class="error-table"><tr><th>Check</th><th>Status</th><th>Fix</th><th>Line</th></tr>';
            for (const check of checks) {
                try {
                    const result = await check.test();
                    table += `<tr><td>${check.name}</td><td>${result ? 'PASS' : 'FAIL'}</td><td>${result ? '' : check.fix}</td><td>${check.line}</td></tr>`;
                } catch (e) {
                    table += `<tr><td>${check.name}</td><td>ERROR</td><td>${check.fix} (Error: ${e})</td><td>${check.line}</td></tr>`;
                }
            }
            table += '</table>';
            consoleDiv.innerHTML += table + '<br>';
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        function downloadErrorLog() {
            const consoleDiv = document.getElementById('console');
            const errors = consoleDiv.innerHTML.split('<br>').filter(line => line.includes('[ERROR]') || line.includes('FAIL') || line.includes('ERROR'));
            const blob = new Blob([errors.join('\n')], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'error_log.txt';
            a.click();
            URL.revokeObjectURL(url);
        }
        document.getElementById('command-input').addEventListener('keypress', async function(e) {
            if (e.key === 'Enter') {
                const code = e.target.value;
                try {
                    await pyodide.runPythonAsync(code);
                } catch (err) {
                    const consoleDiv = document.getElementById('console');
                    consoleDiv.innerHTML += `[ERROR] ${err.toString()} (Stack: ${err.stack || 'Not available'})<br>`;
                    consoleDiv.scrollTop = consoleDiv.scrollHeight;
                }
                e.target.value = '';
            }
        });
    </script>
</body>
</html>
