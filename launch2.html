<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Launch Sequence</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Orbitron', sans-serif;
            background: #000;
            color: #39FF14;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: auto;
            position: relative;
        }
        #app-container {
            width: 90vw;
            max-width: 800px;
            min-height: 80vh;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #39FF14;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px #39FF14;
        }
        h1 {
            font-size: 1.8rem;
            text-align: center;
            text-shadow: 0 0 5px #39FF14;
            margin-bottom: 10px;
        }
        #globe-container {
            width: 100%;
            height: 200px;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
            box-shadow: 0 0 10px #39FF14;
        }
        #agent-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            flex-grow: 1;
            overflow-y: auto;
            padding: 5px;
        }
        .agent-card {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #39FF14;
            border-radius: 5px;
            padding: 10px;
            font-size: 0.85rem;
            text-shadow: 0 0 3px #39FF14;
            box-shadow: 0 0 5px #39FF14;
            transition: transform 0.2s;
        }
        .agent-card:hover {
            transform: scale(1.02);
        }
        .controls {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 10px;
            justify-content: center;
        }
        button {
            background: transparent;
            border: 1px solid #39FF14;
            color: #39FF14;
            padding: 6px 12px;
            font-size: 0.75rem;
            border-radius: 3px;
            cursor: pointer;
            text-shadow: 0 0 3px #39FF14;
            transition: all 0.2s;
        }
        button:hover {
            background: #39FF14;
            color: #000;
            box-shadow: 0 0 10px #39FF14;
        }
        button:disabled {
            border-color: #333;
            color: #333;
            cursor: not-allowed;
        }
        select, input[type="checkbox"], input[type="text"], input[type="number"] {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #39FF14;
            color: #39FF14;
            padding: 6px;
            font-size: 0.75rem;
            border-radius: 3px;
        }
        select:disabled, input:disabled {
            border-color: #333;
            color: #333;
        }
        #status-bar {
            font-size: 0.75rem;
            text-align: center;
            text-shadow: 0 0 3px #39FF14;
            margin-top: 10px;
        }
        #copyright {
            font-size: 0.65rem;
            text-align: center;
            text-shadow: 0 0 3px #39FF14;
            position: absolute;
            bottom: 10px;
            width: 100%;
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #39FF14;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 0 15px #39FF14;
            width: 90%;
            max-width: 400px;
            z-index: 10;
        }
        .modal h2 {
            font-size: 1.2rem;
            text-shadow: 0 0 3px #39FF14;
            margin-bottom: 10px;
        }
        .modal label {
            font-size: 0.75rem;
            margin: 5px 0 2px;
            display: block;
        }
        .modal input, .modal select {
            width: 100%;
            margin-bottom: 10px;
        }
        .modal .controls {
            justify-content: space-between;
        }
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.75rem;
        }
        @media (max-width: 600px) {
            #app-container { width: 95vw; padding: 10px; }
            h1 { font-size: 1.5rem; }
            #globe-container { height: 150px; }
            .agent-list { grid-template-columns: 1fr; }
            .agent-card { font-size: 0.8rem; }
            button, select, input { font-size: 0.7rem; padding: 10px; }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="app-container">
        <h1>Launch Sequence</h1>
        <div id="globe-container"></div>
        <div class="controls">
            <div class="toggle-switch">
                <label>Mode: <span id="mode-label">Sim</span></label>
                <input type="checkbox" id="toggle-switch" onchange="toggleSimulator()">
            </div>
            <button id="launch-seq">Launch</button>
        </div>
        <div id="agent-list"></div>
        <div id="status-bar"></div>
    </div>
    <div id="copyright">Â© 2025 WebXOS - 05:17 PM EDT, Mon, Jun 16, 2025</div>
    <div id="api-modal" class="modal">
        <h2 id="modal-agent-id">Settings - Agent <span id="modal-agent-id"></span></h2>
        <label for="agent-type">Agent Type</label>
        <select id="agent-type">
            <option value="Rocket">Rocket</option>
            <option value="Drone">Drone</option>
            <option value="Satellite">Satellite</option>
            <option value="Rover">Rover</option>
            <option></select>
        </div>
        <label for="agent-task">Task</label>
        <select id="agent-task">
            <option value="None</option>
            <option value="Launch">Launch</option>
            value="Orbit" <option value="Orbit">Orbit</option>
            <option value="Hold">Hold</option>
            <option value="Survey">Survey</option>
            <option value="Return">Return</option>
        </select>
        <label for="api-endpoint">API Endpoint</label>
        <input id="api-endpoint" placeholder="API URL">
        <label for="api-key">API Key</label>
        <input id="api-key" placeholder="API Key">
        <label for="cloud-seeding">Seeding Parameters</label>
        <input id="cloud-seeding" placeholder="Params">
        <label for="iot-id">IoT Device ID</label>
        <input id="iot-id" placeholder="Device ID">
        <label for="altitude-target">Altitude Target (km)</label>
        <input id="altitude-target" type="number" min="0" value="0">
        <label for="speed-target">Speed Target (km/h)</label>
        <input id="speed-target" type="number" min="0" value="0">
        <div class="controls">
            <button class="button" onclick="testApiConnection()">Test</button>
            <button class="button" onclick="saveApiSettings()">Save</button>
            <button class="button" onclick="closeModal()">Close</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r162/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/threejs-extras/1.15.0/OrbitControls.min.js"></script>
    <script>
        let simulatorMode = true;
        let apiConnections = {};
        let ws = null;
        let agents = [
            { id: 1, type: 'Rocket', status: 'Idle', task: 'None', location: { lat: 28.5, lng: -80.6, alt: 0 }, api: { endpoint: '', key: '', seeding: '' }, iotDeviceId: '', targetAltitude: 0, targetSpeed: 0, quantumLinked: false, path: [] },
            { id: 2, type: 'Drone', status: 'Idle', task: 'None', location: { lat: 28.6, lng: -80.7, alt: 100 }, api: { endpoint: '', key: '', seeding: '' }, iotDeviceId: '', targetAltitude: 2, targetSpeed: 50, quantumLinked: false, path: [] },
            { id: 3, type: 'Satellite', status: 'Idle', task: 'None', location: { lat: 0, lng: 0, alt: 36000 }, api: { endpoint: '', key: '', seeding: '' }, iotDeviceId: '', targetAltitude: 500, targetSpeed: 27000, quantumLinked: false, path: [] },
            { id: 4, type: 'Rover', status: 'Idle', task: 'None', location: { lat: 34.5, lng: -80.5, alt: 0 }, api: { endpoint: '', key: '', seeding: '' }, iotDeviceId: '', targetAltitude: 0, targetSpeed: 5, quantumLinked: false, path: [] },
        ];
        
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(50, 800 / 200, 0.innerWidth / 150 );
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(800, 150 );
        document.getElementById('globe-container').appendChild(renderer.domElement);
        const textureLoader = new THREE.TextureLoader();
        const globe = new THREE.Mesh(
            new THREE.SphereGeometry(5, 64, 64),
            new THREE.MeshPhongMaterial({
                map: textureLoader.load('https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg'),
                specularMap: new THREE.MeshBasicMaterial({ color: 0x333333 }),
                shininess: 20
            })
        );
        scene.add(globe);
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);
        const pointLight = new THREE.PointLight(0xffffff, 0.5);
        pointLight.position.set(10, 10, 10);
        scene.add(pointLight);
        camera.position.set(0, 0, 10);
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 6;
        controls.maxDistance = 20;
        controls.enablePan = true;
        
        function addAgentMarkers() {
            scene.children = [globe, ambientLight, pointLight];
            agents.forEach(agent => {
                const phi = (90 - agent.location.lat) * Math.PI / 180;
                const theta = (agent.location.lng + 180) * Math.PI / 180;
                const radius = 5 + agent.location.alt / 10000;
                const x = radius * Math.sin(phi) * Math.cos(theta);
                const y = radius * Math.cos(phi);
                const z = radius * Math.sin(phi) * sin(theta);
                const marker = new THREE.Mesh(
                    new THREE.SphereGeometry(0.15, 16, 16),
                    new THREE.MeshBasicMaterial({ color: agent.type === 'Rocket' ? 0xFF000 : agent.type === 'Drone' ? '#Blue' : agent.type === 'Satellite' ? '#FFFF00' : '#FF4500' })
                );
                marker.position.set(x, y, z);
                scene.add(marker);

                // Add path trail
                if (agent.path.length > 1) {
                    const points = agent.path.map(p => {
                        const pPhi = (90 - p.lat) * Math.PI / 180;
                        const pTheta = (p.lng + 180) * Math.PI / 180;
                        const pRadius = 5 + p.alt / 10000;
                        return new THREE.Vector3(
                            pRadius * Math.sin(pPhi) * Math.cos(pTheta),
                            pRadius * Math.cos(pPhi),
                            pRadius * Math.sin(pPhi) * Math.sin(pTheta)
                        );
                    });
                    const geometry = new THREE.BufferGeometry().setFromPoints(points);
                    const material = new THREE.LineBasicMaterial({ color: 0x39FF14, linewidth: 1 });
                    const line = new THREE.Line(geometry, material);
                    scene.add(line);
                });
            });
        }

        function animateGlobe() {
            requestAnimationFrame(animateGlobe);
            controls.update();
            renderer.render(scene, camera);
        }
        animateGlobe();

        class MockWebSocket {
            constructor() {
                this.listeners = [];
                if (simulatorMode) this.simulateData();
            }
            addEventListener(type, callback) {
                if (type === 'message') this.listeners.push(callback);
            }
            simulateData() {
                setInterval(() => {
                    const data = agents.map(a => {
                        const newLocation = {
                            lat: a.location.lat + (Math.random() - 0.5) * 0.05,
                            lng: a.location.lng + (Math.random() - 0.5) * 0.05,
                            alt: Math.max(0, a.location.alt + (Math.random() - 0.5) * a.targetAltitude * 0.01)
                        };
                        a.path.push({ ...newLocation });
                        if (a.path.length > 50) a.path.shift();
                        return {
                            id: a.id,
                            location: newLocation,
                            status: a.status,
                            task: a.task,
                            speed: a.targetSpeed * (0.8 + Math.random() * 0.4)
                        };
                    });
                    this.listeners.forEach(l => l({ data: JSON.stringify(data) }));
                }, 1000);
            }
        }

        function initWebSocket() {
            if (ws) ws.close();
            ws = simulatorMode ? new MockWebSocket() : new WebSocket('ws://your-api');
            ws.addEventListener('message', e => {
                try {
                    const data = JSON.parse(e.data);
                    data.forEach(u => {
                        const a = agents.find(a => a.id === u.id);
                        if (a) {
                            a.location = u.location;
                            a.status = u.status;
                            a.task = u.task || a.task;
                            a.path.push({ ...u.location });
                            if (a.path.length > 50) a.path.shift();
                            if (u.iotData) a.iotDeviceId = u.iotData.deviceId;
                        }
                    });
                    updateAgentList();
                } catch (err) {
                    console.error('WebSocket error:', err);
                }
            });
            ws.addEventListener('error', () => {
                document.getElementById('status-bar').innerText = 'Connection Error';
            });
        }

        function updateAgentList() {
            const list = document.getElementById('agent-list');
            list.innerHTML = agents.map(a => `
                <div class="agent-card">
                    <div>Agent ${a.id} (${a.type})</div>
                    <div>Status: ${a.status}</div>
                    <div>Task: ${a.task}</div>
                    <div>Loc: ${a.location.lat.toFixed(1)}, ${a.location.lng.toFixed(1)}, Alt: ${a.location.alt.toFixed(0)}km</div>
                    <div>Speed: ${a.targetSpeed.toFixed(0)}km/h</div>
                    <div class="controls">
                        <select id="select" onchange="assignTask(${a.id}, this.value)" ${!simulatorMode && !apiConnections[a.id]?.valid ? 'disabled' : ''}>
                            <option value="None">Task</option>
                            <option value="Launch">Launch</option>
                            <option value="Orbit">Orbit</option>
                            <option value="Hold">Hold</option>
                            <option value="Survey">Survey</option>
                            <option value="Return</option>
                        </select>
                        <button onclick="toggleQuantum(${a.id})">Q-Link</button>
                        <input type="checkbox" onchange="toggleQuantum(${a.id}, this.checked)" ${a.quantumLinked ? 'checked' : ''} ${!simulatorMode && !apiConnections[a.id]?.valid ? 'disabled' : ''}>
                        <button onclick="openApiModal(${a.id})">Set</button>
                    </div>
                </div>
            </div>`).join('');
            const isConnected = agents.every(a => simulatorMode || apiConnections[a.id]?.valid);
            document.getElementById('launch-seq').disabled = !simulatorMode && !isConnected;
            document.getElementById('status-bar').innerText = simulatorMode ? 'Simulator Mode' : (isConnected ? 'API Connected' : 'API Not Connected');
            document.getElementById('mode-label').innerText = simulatorMode ? 'Sim' : 'Live';
            document.getElementById('toggle-mode').checked = !simulatorMode;
            addAgentMarkers();
        }

        function assignTask(id, task) {
            const a = agents.find(a => a.id === id);
            a.task = task;
            a.status = task === 'None' ? 'Idle' : `Executing ${task}`;
            if (a.quantumLinked) {
                agents.forEach(other => {
                    if (other.id !== id) {
                        other.task = task;
                        other.status = a.status;
                    }
                });
            }
            if (!simulatorMode && apiConnections[id]?.valid) {
                fetchTelemetry(id, task);
                fetchIoT(id);
            }
            updateAgentList();
        }

        function toggleQuantum(id, checked = !agents.find(a => a.id === id).quantumLinked) {
            const a = agents.find(a => a.id === id);
            a.quantumLinked = checked;
            if (a.quantumLinked && a.task !== 'None') {
                agents.forEach(other => {
                    if (other.id !== id) {
                        other.task = a.task;
                        other.status = a.status;
                    }
                });
            }
            updateAgentList();
        }

        function resetAgent(id) {
            const a = agents.find(a => a.id === id);
            a.status = 'Idle';
            a.task = 'None';
            a.location = { lat: 28.5 + id * 0.1, lng: -80.6 - id, id * 0.1, alt: a.type === 'Drone' ? 1 : a.type === 'Satellite' ? 36000 : 0 };
            a.targetSpeed = a.type === 'Drone' ? 50 : a.type === 'Satellite' ? 27000 : a.type === 'Rover' ? 5 : 0;
            a.quantumLinked = false;
            a.path = [];
            if (!simulatorMode && apiConnections[id]?.valid) {
                fetchTelemetry(id, 'Reset');
                fetchIoT(id);
            }
            updateAgentList();
        }

        function initiateLaunchSequence() {
            const seq = ['Pre-Launch', 'Ignition', 'Ascent', 'Orbit'];
            let step = 0;
            const interval = setInterval(() => {
                if (step < seq.length) {
                    agents.forEach(a => {
                        a.task = seq[step];
                        a.status = `Executing ${seq[step]}`;
                        a.location.alt = a.targetAltitude * (step + 1) / seq.length;
                        a.path.push({ ...a.location });
                        if (a.path.length > 50) a.path.shift();
                        if (!simulatorMode && apiConnections[a.id]?.valid) {
                            fetchTelemetry(a.id, seq[step]);
                            fetchIoT(a.id);
                        }
                    });
                    updateAgentList();
                    step++;
                } else {
                    clearInterval(interval);
                }
            }, 1500);
        }

        async function fetchTelemetry(id, task) {
            const agent = agents.find(a => a.id === id);
            console.log(`Fetching telemetry for ID ${id}: ${agent.api.endpoint}, Task: ${task}`);
            // Placeholder: Replace with actual API call
            return { status: 'Success' };
        }

        async function fetchIoT(id) {
            const agent = agents.find(a => a.id === id);
            if (agent.iotDeviceId) {
                console.log(`Fetching IoT data for device ${agent.iotDeviceId}`);
                // Placeholder: Replace with actual IoT API call
                return { status: 'Connected' };
            }
        }

        function openApiModal(id) {
            const a = agents.find(a => a.id === id);
            document.getElementById('modal-agent-id').innerText = id;
            document.getElementById('agent-type').value = a.type;
            document.getElementById('agent-task').value = a.task;
            document.getElementById('api-endpoint').value = a.api.endpoint;
            document.getElementById('api-key').value = a.api.key;
            document.getElementById('cloud-seeding').value = a.api.seeding;
            document.getElementById('iot-id').value = a.iotDeviceId;
            document.getElementById('altitude-target').value = a.targetAltitude;
            document.getElementById('speed-target').value = a.targetSpeed;
            document.getElementById('api-modal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('api-modal').style.display = 'none';
        }

        function saveApiSettings() {
            const id = parseInt(document.getElementById('modal-agent-id').innerText);
            const a = agents.find(a => a.id === id);
            a.type = document.getElementById('agent-type').value;
            a.task = document.getElementById('agent-task').value;
            a.status = a.task === 'None' ? 'Idle' : `Executing ${a.task}`;
            a.api.endpoint = document.getElementById('api-endpoint').value;
            a.api.key = document.getElementById('api-key').value;
            a.api.seeding = document.getElementById('cloud-seeding').value;
            a.iotDeviceId = document.getElementById('iot-id').value;
            a.targetAltitude = parseFloat(document.getElementById('altitude-target').value) || 0;
            a.targetSpeed = parseFloat(document.getElementById('speed-target').value) || 0;
            if (a.quantumLinked && a.task !== 'None') {
                agents.forEach(other => {
                    if (other.id !== id) {
                        other.task = a.task;
                        other.status = a.status;
                    }
                });
            }
            closeModal();
            testApiConnection(id);
            updateAgentList();
        }

        async function validateApiConnection(id) {
            const a = agents.find(a => a.id === id);
            const valid = !!a.api.endpoint && !!a.api.key;
            return { valid };
        }

        async function testApiConnection(id = parseInt(document.getElementById('modal-agent-id').innerText)) {
            const result = await validateApiConnection(id);
            apiConnections[id] = result;
            updateAgentList();
        }

        function toggleSimulator() {
            simulatorMode = !simulatorMode;
            initWebSocket();
            updateAgentList();
        }

        // Event listeners
        document.getElementById('launch-seq').addEventListener('click', initiateLaunchSequence);
        document.getElementById('toggle-switch').addEventListener('change', toggleSimulator);

        // Initialize
        initWebSocket();
        updateAgentList();
    </script>
</body>
</html>
