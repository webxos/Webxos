<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="Bulletin Board by WebXOS: Lightweight, browser-based bulletin board for private/public networks with secure posting, file sharing, API access, and minimalist terminal UI.">
    <meta name="keywords" content="bulletin board, secure posting, offline board, browser-based board, minimalist UI, private rooms, WebXOS, API server">
    <meta name="author" content="WebXOS">
    <meta name="robots" content="index, follow">
    <title>WebXOS Bulletin Board</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            font-size: 3vw;
        }
        h1 {
            font-size: 5vw;
            text-align: center;
            text-shadow: 0 0 3px #0f0;
            margin: 2px 0;
        }
        #start-menu, #container {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-height: 100vh;
            overflow: hidden;
            width: 100%;
            padding: 5px;
        }
        #container { display: none; }
        #start-menu button, #modal-content button, #board button, #profile button {
            background: #111;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 5px;
            font-size: 3.5vw;
            cursor: pointer;
            border-radius: 3px;
            width: 90%;
            max-width: 200px;
            margin: 2px 0;
            transition: background 0.3s, color 0.3s;
        }
        #start-menu button:hover, #modal-content button:hover, #board button:hover, #profile button:hover {
            background: #0f0;
            color: #000;
        }
        #public-boards-list {
            width: 90%;
            max-width: 200px;
            margin: 5px 0;
            text-align: center;
        }
        #public-boards-list h3 {
            font-size: 3.5vw;
            margin: 2px 0;
        }
        #public-boards-list ul {
            list-style: none;
            max-height: 15vh;
            overflow-y: auto;
            padding: 0;
            margin: 0;
        }
        #public-boards-list li {
            background: #111;
            border: 1px solid #0f0;
            padding: 3px;
            margin: 2px 0;
            border-radius: 3px;
            font-size: 3vw;
            cursor: pointer;
        }
        #public-boards-list li:hover {
            background: #0f0;
            color: #000;
        }
        #modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #modal-content {
            background: #111;
            padding: 10px;
            border: 1px solid #0f0;
            border-radius: 3px;
            width: 90%;
            max-width: 300px;
            text-align: center;
        }
        #modal-content input, #modal-content select {
            background: #222;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 5px;
            margin: 2px 0;
            font-family: 'Courier New', monospace;
            width: 100%;
            font-size: 3.5vw;
            border-radius: 3px;
        }
        #modal-content input[type="checkbox"] {
            width: auto;
            margin: 5px 3px;
        }
        #board, #profile {
            width: 100%;
            border: 1px solid #0f0;
            padding: 5px;
            border-radius: 3px;
            margin: 2px 0;
        }
        #profile {
            font-size: 2.5vw;
            padding: 3px;
        }
        #board-posts {
            height: 50vh;
            overflow-y: auto;
            border: 1px solid #0f0;
            padding: 5px;
            margin-bottom: 5px;
            background: #111;
            flex-grow: 1;
        }
        .post {
            margin: 3px 0;
            word-wrap: break-word;
            font-size: 3vw;
        }
        .post img {
            max-width: 60%;
            border-radius: 3px;
            margin: 3px 0;
        }
        .post a {
            color: #0f0;
            text-decoration: underline;
        }
        #board input {
            background: #222;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 5px;
            margin: 2px 0;
            font-family: 'Courier New', monospace;
            width: 100%;
            font-size: 3.5vw;
            border-radius: 3px;
        }
        #file-input { padding: 3px; }
        @media (min-width: 768px) {
            body { font-size: 16px; }
            h1 { font-size: 24px; }
            #start-menu button, #modal-content button, #board button, #profile button { font-size: 14px; max-width: 250px; padding: 8px; }
            #modal-content input, #modal-content select, #board input { font-size: 14px; }
            #public-boards-list h3 { font-size: 16px; }
            #public-boards-list li { font-size: 12px; }
            #profile { font-size: 12px; }
            .post { font-size: 12px; }
            #board-posts { max-height: 70%; }
        }
    </style>
</head>
<body>
    <div id="start-menu">
        <h1>WebXOS Bulletin Board</h1>
        <button onclick="showCreateBoardModal()">Create Board</button>
        <button onclick="showJoinBoardModal()">Join Board</button>
        <div id="public-boards-list">
            <h3>Public Boards</h3>
            <ul id="public-boards-items"></ul>
            <button onclick="refreshPublicBoards()">Refresh</button>
        </div>
    </div>
    <div id="modal">
        <div id="modal-content">
            <h2 id="modal-title">Create Board</h2>
            <input type="text" id="creator-input" placeholder="Creator Name">
            <input type="password" id="password-input" placeholder="Board Password">
            <input type="text" id="board-id-input" placeholder="Board ID" readonly style="display: none;">
            <label><input type="checkbox" id="public-board" checked> Public Board</label>
            <select id="public-boards" style="display: none;">
                <option value="">Select Public Board</option>
            </select>
            <button id="modal-action">Create Board</button>
        </div>
    </div>
    <div id="container">
        <h1>WebXOS Bulletin Board</h1>
        <div id="profile">
            <div>Session ID: <span id="session-id"></span></div>
            <div>Board: <span id="board-id"></span> <button onclick="copyBoardId()">Copy</button></div>
            <div>API Key: <span id="api-key"></span> <button onclick="copyApiKey()">Copy</button></div>
        </div>
        <div id="board">
            <div id="board-posts"></div>
            <input type="text" id="post-input" placeholder="Post message...">
            <input type="file" id="file-input" accept="image/*,*">
            <button onclick="submitPost()">Post</button>
        </div>
    </div>
    <script>
        let virtualServer = JSON.parse(localStorage.getItem('virtualServer')) || {
            agents: {}, boards: {}, posts: {}, files: {}
        };
        let ws = null; // WebSocket placeholder
        let boardId = localStorage.getItem('boardId');
        let sessionId = localStorage.getItem('sessionId');
        let currentBoard = '';
        let isCreator = false;

        // Generate UUID for board IDs
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0;
                return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
        }

        // Sync across tabs
        window.addEventListener('storage', event => {
            if (event.key === 'virtualServerUpdate') {
                try {
                    const update = JSON.parse(event.newValue);
                    virtualServer = { ...virtualServer, ...update.data };
                    localStorage.setItem('virtualServer', JSON.stringify(virtualServer));
                    if (currentBoard && update.boardId === currentBoard) {
                        loadPosts();
                    }
                    loadPublicBoardsList();
                    loadPublicBoards();
                } catch (error) {
                    console.error('Storage event error:', error);
                }
            }
        });

        // Broadcast changes
        function broadcastVirtualServer() {
            try {
                localStorage.setItem('virtualServerUpdate', JSON.stringify({ boardId: currentBoard, data: virtualServer }));
                setTimeout(() => localStorage.removeItem('virtualServerUpdate'), 0);
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'board-list', boards: Object.values(virtualServer.boards).filter(b => b.public) }));
                    ws.send(JSON.stringify({ type: 'posts', boardId: currentBoard, posts: virtualServer.posts[currentBoard] || [], files: virtualServer.files[currentBoard] || [] }));
                }
            } catch (error) {
                console.error('Broadcast error:', error);
            }
        }

        // Check if user is already in a board
        function checkLogin() {
            if (boardId && sessionId && virtualServer.boards[boardId]) {
                currentBoard = boardId;
                isCreator = virtualServer.boards[boardId].creatorSessionId === sessionId;
                initializeApp(virtualServer.boards[boardId].public, virtualServer.boards[boardId].password);
            } else {
                document.getElementById('start-menu').style.display = 'flex';
                loadPublicBoardsList();
            }
        }

        // Show create board modal
        function showCreateBoardModal() {
            document.getElementById('modal-title').textContent = 'Create Board';
            document.getElementById('modal-action').textContent = 'Create';
            document.getElementById('board-id-input').value = generateUUID();
            document.getElementById('creator-input').value = '';
            document.getElementById('password-input').value = '';
            document.getElementById('public-board').checked = true;
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('modal-action').onclick = handleCreateBoard;
        }

        // Show join board modal
        function showJoinBoardModal() {
            document.getElementById('modal-title').textContent = 'Join Board';
            document.getElementById('modal-action').textContent = 'Join';
            document.getElementById('board-id-input').value = '';
            document.getElementById('creator-input').value = '';
            document.getElementById('password-input').value = '';
            document.getElementById('public-boards').style.display = 'block';
            document.getElementById('board-id-input').style.display = 'block';
            document.getElementById('creator-input').style.display = 'block';
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('modal-action').onclick = handleJoinBoard;
            loadPublicBoards();
        }

        // Load public boards for join modal
        function loadPublicBoards() {
            const select = document.getElementById('public-boards');
            select.innerHTML = '<option value="">Select Public Board</option>';
            Object.values(virtualServer.boards).forEach(board => {
                if (board.public) {
                    const option = document.createElement('option');
                    option.value = board.id;
                    option.textContent = `Board by ${board.creator} (${board.id.slice(0, 8)})`;
                    select.appendChild(option);
                }
            });
            select.onchange = () => {
                const selectedBoard = select.value;
                document.getElementById('creator-input').style.display = selectedBoard ? 'none' : 'block';
                document.getElementById('board-id-input').style.display = selectedBoard ? 'none' : 'block';
                if (selectedBoard) {
                    document.getElementById('board-id-input').value = selectedBoard;
                }
            };
        }

        // Load public boards list
        function loadPublicBoardsList() {
            const list = document.getElementById('public-boards-items');
            list.innerHTML = '';
            const publicBoards = Object.values(virtualServer.boards).filter(board => board.public);
            if (publicBoards.length === 0) {
                list.innerHTML = '<li>No public boards</li>';
            } else {
                publicBoards.forEach(board => {
                    const li = document.createElement('li');
                    li.textContent = `Board by ${board.creator} (${board.id.slice(0, 8)})`;
                    li.onclick = () => {
                        document.getElementById('public-boards').value = board.id;
                        document.getElementById('board-id-input').value = board.id;
                        showJoinBoardModal();
                    };
                    list.appendChild(li);
                });
            }
        }

        // Refresh public boards
        function refreshPublicBoards() {
            loadPublicBoardsList();
            loadPublicBoards();
        }

        // Handle board creation
        function handleCreateBoard() {
            const creator = document.getElementById('creator-input').value.trim();
            const password = document.getElementById('password-input').value.trim();
            const isPublic = document.getElementById('public-board').checked;
            const newBoardId = document.getElementById('board-id-input').value.trim();

            if (!creator) {
                alert('Please enter a creator name.');
                return;
            }
            if (!password) {
                alert('Please enter a password.');
                return;
            }
            if (!newBoardId) {
                alert('Board ID generation failed. Try again.');
                return;
            }

            sessionId = `Session_${Math.random().toString(36).substr(2, 8)}`;
            boardId = newBoardId;
            localStorage.setItem('boardId', boardId);
            localStorage.setItem('sessionId', sessionId);
            currentBoard = boardId;
            isCreator = true;

            virtualServer.boards[boardId] = {
                id: boardId,
                creator,
                creatorSessionId: sessionId,
                public: isPublic,
                password,
                createdAt: Date.now()
            };
            virtualServer.agents[boardId] = virtualServer.agents[boardId] || {};
            virtualServer.agents[boardId][sessionId] = { id: generateUUID(), sessionId, status: 'active' };
            virtualServer.posts[boardId] = virtualServer.posts[boardId] || [];
            virtualServer.files[boardId] = virtualServer.files[boardId] || [];

            localStorage.setItem('virtualServer', JSON.stringify(virtualServer));
            broadcastVirtualServer();
            initializeApp(isPublic, password);
        }

        // Handle joining a board
        function handleJoinBoard() {
            const password = document.getElementById('password-input').value.trim();
            const creator = document.getElementById('creator-input').value.trim();
            const selectedBoardId = document.getElementById('public-boards').value || document.getElementById('board-id-input').value.trim();

            if (!password) {
                alert('Please enter a password.');
                return;
            }
            if (!selectedBoardId) {
                alert('Please select or enter a board ID.');
                return;
            }

            if (!virtualServer.boards[selectedBoardId]) {
                alert('Board does not exist.');
                return;
            }

            const board = virtualServer.boards[selectedBoardId];
            if (board.public && document.getElementById('public-boards').value) {
                if (board.password !== password) {
                    alert('Invalid password.');
                    return;
                }
            } else {
                if (board.password !== password || board.creator !== creator) {
                    alert('Invalid password or creator name.');
                    return;
                }
            }

            sessionId = `Session_${Math.random().toString(36).substr(2, 8)}`;
            boardId = selectedBoardId;
            localStorage.setItem('boardId', boardId);
            localStorage.setItem('sessionId', sessionId);
            currentBoard = boardId;
            isCreator = false;

            virtualServer.agents[boardId] = virtualServer.agents[boardId] || {};
            virtualServer.agents[boardId][sessionId] = { id: generateUUID(), sessionId, status: 'active' };
            localStorage.setItem('virtualServer', JSON.stringify(virtualServer));
            broadcastVirtualServer();
            initializeApp(board.public, password);
        }

        // Initialize board interface
        function initializeApp(isPublic, password) {
            document.getElementById('start-menu').style.display = 'none';
            document.getElementById('modal').style.display = 'none';
            document.getElementById('container').style.display = 'flex';
            document.getElementById('session-id').textContent = sessionId;
            document.getElementById('board-id').textContent = boardId.slice(0, 8);
            document.getElementById('api-key').textContent = boardId.slice(0, 8);
            loadPosts();
        }

        // Copy board ID
        function copyBoardId() {
            navigator.clipboard.writeText(boardId).then(() => alert('Board ID copied!')).catch(() => alert('Copy failed.'));
        }

        // Copy API key
        function copyApiKey() {
            navigator.clipboard.writeText(boardId).then(() => alert('API Key copied!')).catch(() => alert('Copy failed.'));
        }

        // Submit a post
        function submitPost() {
            const input = document.getElementById('post-input');
            const fileInput = document.getElementById('file-input');
            if (!currentBoard) {
                alert('Join or create a board.');
                return;
            }
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = () => {
                    const fileData = {
                        type: 'file',
                        sessionId,
                        boardId: currentBoard,
                        fileName: file.name,
                        fileData: reader.result,
                        timestamp: Date.now()
                    };
                    saveFile(fileData);
                    appendFilePost(fileData);
                    fileInput.value = '';
                };
                reader.readAsDataURL(file);
            } else {
                const message = input.value.trim();
                if (message) {
                    const postData = {
                        sessionId,
                        content: message,
                        boardId: currentBoard,
                        timestamp: Date.now()
                    };
                    savePost(postData);
                    appendPost(`${sessionId}: ${message}`);
                    input.value = '';
                } else {
                    alert('Enter a message or file.');
                }
            }
        }

        // Save text post
        function savePost(post) {
            virtualServer.posts[currentBoard] = virtualServer.posts[currentBoard] || [];
            virtualServer.posts[currentBoard].push(post);
            localStorage.setItem('virtualServer', JSON.stringify(virtualServer));
            broadcastVirtualServer();
        }

        // Save file post
        function saveFile(file) {
            virtualServer.files[currentBoard] = virtualServer.files[currentBoard] || [];
            virtualServer.files[currentBoard].push({ id: generateUUID(), ...file });
            localStorage.setItem('virtualServer', JSON.stringify(virtualServer));
            broadcastVirtualServer();
        }

        // Append text post
        function appendPost(text) {
            const posts = document.getElementById('board-posts');
            const postDiv = document.createElement('div');
            postDiv.className = 'post';
            postDiv.textContent = text;
            posts.appendChild(postDiv);
            posts.scrollTop = posts.scrollHeight;
        }

        // Append file post
        function appendFilePost(file) {
            const posts = document.getElementById('board-posts');
            const postDiv = document.createElement('div');
            postDiv.className = 'post';
            if (file.fileData.startsWith('data:image/')) {
                const img = document.createElement('img');
                img.src = file.fileData;
                postDiv.textContent = `${file.sessionId} shared image:`;
                postDiv.appendChild(img);
            } else {
                const link = document.createElement('a');
                link.href = file.fileData;
                link.download = file.fileName;
                link.textContent = file.fileName;
                postDiv.textContent = `${file.sessionId} shared file: `;
                postDiv.appendChild(link);
            }
            posts.appendChild(postDiv);
            posts.scrollTop = posts.scrollHeight;
        }

        // Load all posts
        function loadPosts() {
            const posts = document.getElementById('board-posts');
            posts.innerHTML = '';
            (virtualServer.posts[currentBoard] || []).sort((a, b) => a.timestamp - b.timestamp).forEach(post => {
                appendPost(`${post.sessionId}: ${post.content}`);
            });
            (virtualServer.files[currentBoard] || []).sort((a, b) => a.timestamp - b.timestamp).forEach(file => {
                appendFilePost(file);
            });
        }

        // Clean up on exit
        window.onbeforeunload = () => {
            if (virtualServer.agents[boardId] && virtualServer.agents[boardId][sessionId]) {
                virtualServer.agents[boardId][sessionId].status = 'inactive';
                if (isCreator) {
                    delete virtualServer.boards[boardId];
                    delete virtualServer.posts[boardId];
                    delete virtualServer.files[boardId];
                    delete virtualServer.agents[boardId];
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ type: 'delete-board', boardId }));
                    }
                }
                localStorage.setItem('virtualServer', JSON.stringify(virtualServer));
                broadcastVirtualServer();
            }
            localStorage.removeItem('boardId');
            localStorage.removeItem('sessionId');
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            }
        };

        // Initialize
        checkLogin();
    </script>
</body>
</html>
