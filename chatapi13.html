<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="Post API: Lightweight, browser-based API bulletin generator for private/public data sharing with real-time API endpoints and minimalist terminal UI.">
    <title>Post API</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            font-size: 3vw;
        }
        h1 {
            font-size: 5vw;
            text-align: center;
            text-shadow: 0 0 3px #0f0;
            margin: 2px 0;
        }
        #start-menu, #container {
            display: flex;
            flex-direction: column;
            align-items: center;
            max-height: 100vh;
            overflow: hidden;
            width: 100%;
            padding: 5px;
        }
        #container { display: none; }
        #start-menu button, #modal-content button, #board button, #profile button {
            background: #111;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 5px;
            font-size: 3.5vw;
            cursor: pointer;
            border-radius: 3px;
            width: 90%;
            max-width: 200px;
            margin: 2px 0;
            transition: background 0.3s, color 0.3s;
        }
        #start-menu button:hover, #modal-content button:hover, #board button:hover, #profile button:hover {
            background: #0f0;
            color: #000;
        }
        #public-boards-list {
            width: 90%;
            max-width: 200px;
            margin: 5px 0;
            text-align: center;
        }
        #public-boards-list h3 {
            font-size: 3.5vw;
            margin: 2px 0;
        }
        #public-boards-list ul {
            list-style: none;
            max-height: 15vh;
            overflow-y: auto;
            padding: 0;
            margin: 0;
        }
        #public-boards-list li {
            background: #111;
            border: 1px solid #0f0;
            padding: 3px;
            margin: 2px 0;
            border-radius: 3px;
            font-size: 3vw;
            cursor: pointer;
        }
        #public-boards-list li:hover {
            background: #0f0;
            color: #000;
        }
        #modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #modal-content {
            background: #111;
            padding: 10px;
            border: 1px solid #0f0;
            border-radius: 3px;
            width: 90%;
            max-width: 300px;
            text-align: center;
        }
        #modal-content input, #modal-content select {
            background: #222;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 5px;
            margin: 2px 0;
            font-family: 'Courier New', monospace;
            width: 100%;
            font-size: 3.5vw;
            border-radius: 3px;
        }
        #modal-content input[type="checkbox"] {
            width: auto;
            margin: 5px 3px;
        }
        #board, #profile {
            width: 100%;
            border: 1px solid #0f0;
            padding: 5px;
            border-radius: 3px;
            margin: 2px 0;
        }
        #profile {
            font-size: 2.5vw;
            padding: 3px;
        }
        #board-posts {
            height: 50vh;
            overflow-y: auto;
            border: 1px solid #0f0;
            padding: 5px;
            margin-bottom: 5px;
            background: #111;
            flex-grow: 1;
        }
        .post {
            margin: 3px 0;
            word-wrap: break-word;
            font-size: 3vw;
        }
        .post img {
            max-width: 60%;
            border-radius: 3px;
            margin: 3px 0;
        }
        .post a {
            color: #0f0;
            text-decoration: underline;
        }
        #board input {
            background: #222;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 5px;
            margin: 2px 0;
            font-family: 'Courier New', monospace;
            width: 100%;
            font-size: 3.5vw;
            border-radius: 3px;
        }
        #file-input { padding: 3px; }
        @media (min-width: 768px) {
            body { font-size: 16px; }
            h1 { font-size: 24px; }
            #start-menu button, #modal-content button, #board button, #profile button { font-size: 14px; max-width: 250px; padding: 8px; }
            #modal-content input, #modal-content select, #board input { font-size: 14px; }
            #public-boards-list h3 { font-size: 16px; }
            #public-boards-list li { font-size: 12px; }
            #profile { font-size: 12px; }
            .post { font-size: 12px; }
            #board-posts { max-height: 70%; }
        }
    </style>
</head>
<body>
    <div id="start-menu">
        <h1>Post API</h1>
        <button onclick="showCreateBoardModal()">Create API Bulletin</button>
        <button onclick="showJoinBoardModal()">Join API Bulletin</button>
        <div id="public-boards-list">
            <h3>Public API Bulletins</h3>
            <ul id="public-boards-items"></ul>
            <button onclick="refreshPublicBoards()">Refresh</button>
        </div>
    </div>
    <div id="modal">
        <div id="modal-content">
            <h2 id="modal-title">Create API Bulletin</h2>
            <input type="text" id="creator-input" placeholder="Creator Name">
            <input type="password" id="password-input" placeholder="Bulletin Password (optional for private)">
            <input type="text" id="board-id-input" placeholder="Bulletin ID" readonly style="display: none;">
            <label><input type="checkbox" id="public-board" checked> Public Bulletin</label>
            <select id="public-boards" style="display: none;">
                <option value="">Select Public API Bulletin</option>
            </select>
            <button id="modal-action">Create Bulletin</button>
        </div>
    </div>
    <div id="container">
        <h1>Post API</h1>
        <div id="profile">
            <div>Session ID: <span id="session-id"></span></div>
            <div>Bulletin: <span id="board-id"></span> <button onclick="copyBoardId()">Copy</button></div>
            <div>API Endpoint: <span id="api-key"></span> <button onclick="copyApiKey()">Copy</button></div>
            <button onclick="leaveBoard()">Leave Bulletin</button>
        </div>
        <div id="board">
            <div id="board-posts"></div>
            <input type="text" id="post-input" placeholder="Post message to API...">
            <input type="file" id="file-input" accept="image/*,*">
            <button onclick="submitPost()">Post</button>
        </div>
    </div>
    <script>
        // IndexedDB setup
        const dbName = "PostAPIDB";
        const dbVersion = 1;
        let db;
        const request = indexedDB.open(dbName, dbVersion);
        request.onupgradeneeded = (event) => {
            db = event.target.result;
            db.createObjectStore("bulletins", { keyPath: "id" });
            db.createObjectStore("posts", { keyPath: "id" });
            db.createObjectStore("files", { keyPath: "id" });
            db.createObjectStore("tokens", { keyPath: "boardId" });
        };
        request.onsuccess = (event) => {
            db = event.target.result;
        };

        let boardId = localStorage.getItem('boardId');
        let sessionId = localStorage.getItem('sessionId');
        let currentBoard = '';
        let isCreator = false;
        let peerConnections = new Map();
        let dataChannel = null;
        const signalingChannel = new BroadcastChannel('post-api-signaling');

        // Generate UUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0;
                return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
        }

        // Generate API token
        function generateApiToken() {
            return 'api_' + Math.random().toString(36).substr(2, 16);
        }

        // Register Service Worker
        async function registerServiceWorker(boardId, token) {
            const swCode = `
                self.addEventListener('fetch', event => {
                    const url = new URL(event.request.url);
                    if (url.pathname.startsWith('/api/${boardId}/${token}')) {
                        event.respondWith((async () => {
                            const db = await new Promise(resolve => {
                                const req = indexedDB.open('${dbName}', ${dbVersion});
                                req.onsuccess = () => resolve(req.result);
                            });
                            const tx = db.transaction(['posts', 'files'], 'readonly');
                            const posts = await new Promise(resolve => {
                                tx.objectStore('posts').getAll().onsuccess = e => resolve(e.target.result);
                            });
                            const files = await new Promise(resolve => {
                                tx.objectStore('files').getAll().onsuccess = e => resolve(e.target.result);
                            });
                            return new Response(JSON.stringify({ posts, files }), {
                                headers: { 'Content-Type': 'application/json' }
                            });
                        })());
                    }
                });
            `;
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            await navigator.serviceWorker.register(swUrl);
            console.log(`Service Worker registered for API: /api/${boardId}/${token}`);
        }

        // Unregister Service Worker
        async function unregisterServiceWorker() {
            const registrations = await navigator.serviceWorker.getRegistrations();
            for (const reg of registrations) {
                await reg.unregister();
            }
            console.log('Service Worker unregistered');
        }

        // Initialize WebRTC
        async function initWebRTC(boardId, isPublic) {
            const peer = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
            dataChannel = peer.createDataChannel('post-api');
            dataChannel.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'post' || data.type === 'file') {
                    saveData(data);
                    loadPosts();
                }
            };
            peerConnections.set(boardId, peer);

            peer.onicecandidate = (event) => {
                if (event.candidate) {
                    signalingChannel.postMessage({ boardId, candidate: event.candidate, isPublic });
                }
            };

            const offer = await peer.createOffer();
            await peer.setLocalDescription(offer);
            signalingChannel.postMessage({ boardId, offer, isPublic });
        }

        // Handle signaling messages
        signalingChannel.onmessage = async (event) => {
            const { boardId, candidate, offer, answer, isPublic } = event.data;
            const peer = peerConnections.get(boardId);
            if (!peer) return;

            if (offer) {
                await peer.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await peer.createAnswer();
                await peer.setLocalDescription(answer);
                signalingChannel.postMessage({ boardId, answer, isPublic });
            } else if (answer) {
                await peer.setRemoteDescription(new RTCSessionDescription(answer));
            } else if (candidate) {
                await peer.addIceCandidate(new RTCIceCandidate(candidate));
            }

            if (isPublic) {
                loadPublicBoardsList();
            }
        };

        // Save data to IndexedDB
        async function saveData(data) {
            const tx = db.transaction(['posts', 'files', 'bulletins', 'tokens'], 'readwrite');
            if (data.type === 'post') {
                tx.objectStore('posts').put({ id: generateUUID(), ...data });
            } else if (data.type === 'file') {
                tx.objectStore('files').put({ id: generateUUID(), ...data });
            } else if (data.type === 'bulletin') {
                tx.objectStore('bulletins').put(data);
            } else if (data.type === 'token') {
                tx.objectStore('tokens').put(data);
            }
            await new Promise(resolve => tx.oncomplete = resolve);
        }

        // Load public boards
        async function loadPublicBoardsList() {
            const tx = db.transaction('bulletins', 'readonly');
            const bulletins = await new Promise(resolve => {
                tx.objectStore('bulletins').getAll().onsuccess = e => resolve(e.target.result);
            });
            const list = document.getElementById('public-boards-items');
            list.innerHTML = '';
            const publicBulletins = bulletins.filter(b => b.public);
            if (publicBulletins.length === 0) {
                list.innerHTML = '<li>No public API bulletins</li>';
            } else {
                publicBulletins.forEach(bulletin => {
                    const li = document.createElement('li');
                    li.textContent = `Bulletin by ${bulletin.creator} (${bulletin.id.slice(0, 8)})`;
                    li.onclick = () => {
                        document.getElementById('public-boards').value = bulletin.id;
                        document.getElementById('board-id-input').value = bulletin.id;
                        showJoinBoardModal();
                    };
                    list.appendChild(li);
                });
            }
        }

        // Create bulletin
        async function handleCreateBoard() {
            const creator = document.getElementById('creator-input').value.trim();
            const password = document.getElementById('password-input').value.trim();
            const isPublic = document.getElementById('public-board').checked;
            const newBoardId = generateUUID();

            if (!creator) {
                alert('Please enter a creator name.');
                return;
            }

            sessionId = `Session_${Math.random().toString(36).substr(2, 8)}`;
            boardId = newBoardId;
            localStorage.setItem('boardId', boardId);
            localStorage.setItem('sessionId', sessionId);
            currentBoard = boardId;
            isCreator = true;

            const token = generateApiToken();
            await saveData({
                type: 'bulletin',
                id: boardId,
                creator,
                creatorSessionId: sessionId,
                public: isPublic,
                password: isPublic ? '' : password,
                createdAt: Date.now()
            });
            await saveData({ type: 'token', boardId, token });
            await registerServiceWorker(boardId, token);
            await initWebRTC(boardId, isPublic);

            initializeApp(isPublic, password);
            alert(`Bulletin created! API Endpoint: /api/${boardId}/${token}`);
        }

        // Join bulletin
        async function handleJoinBoard() {
            const password = document.getElementById('password-input').value.trim();
            const creator = document.getElementById('creator-input').value.trim();
            const selectedBoardId = document.getElementById('public-boards').value || document.getElementById('board-id-input').value.trim();

            if (!selectedBoardId) {
                alert('Please select or enter a bulletin ID.');
                return;
            }

            const tx = db.transaction('bulletins', 'readonly');
            const bulletin = await new Promise(resolve => {
                tx.objectStore('bulletins').get(selectedBoardId).onsuccess = e => resolve(e.target.result);
            });

            if (!bulletin) {
                alert('Bulletin does not exist.');
                return;
            }

            if (!bulletin.public && (bulletin.password !== password || bulletin.creator !== creator)) {
                alert('Invalid password or creator name.');
                return;
            }

            sessionId = `Session_${Math.random().toString(36).substr(2, 8)}`;
            boardId = selectedBoardId;
            localStorage.setItem('boardId', boardId);
            localStorage.setItem('sessionId', sessionId);
            currentBoard = boardId;
            isCreator = false;

            await initWebRTC(boardId, bulletin.public);
            initializeApp(bulletin.public, password);
        }

        // Initialize app
        function initializeApp(isPublic, password) {
            document.getElementById('start-menu').style.display = 'none';
            document.getElementById('modal').style.display = 'none';
            document.getElementById('container').style.display = 'flex';
            document.getElementById('session-id').textContent = sessionId;
            document.getElementById('board-id').textContent = boardId.slice(0, 8);
            document.getElementById('api-key').textContent = `/api/${boardId}/${virtualServer.apiTokens[boardId]?.token || ''}`;
            loadPosts();
        }

        // Leave bulletin
        async function leaveBoard() {
            if (isCreator) {
                const tx = db.transaction(['bulletins', 'posts', 'files', 'tokens'], 'readwrite');
                tx.objectStore('bulletins').delete(boardId);
                tx.objectStore('posts').delete(boardId);
                tx.objectStore('files').delete(boardId);
                tx.objectStore('tokens').delete(boardId);
                await new Promise(resolve => tx.oncomplete = resolve);
                await unregisterServiceWorker();
                peerConnections.get(boardId)?.close();
                peerConnections.delete(boardId);
            }
            localStorage.removeItem('boardId');
            localStorage.removeItem('sessionId');
            currentBoard = '';
            sessionId = '';
            boardId = '';
            isCreator = false;
            document.getElementById('container').style.display = 'none';
            document.getElementById('start-menu').style.display = 'flex';
            loadPublicBoardsList();
        }

        // Copy board ID
        function copyBoardId() {
            navigator.clipboard.writeText(boardId).then(() => alert('Bulletin ID copied!')).catch(() => alert('Copy failed.'));
        }

        // Copy API key
        function copyApiKey() {
            const apiKey = `/api/${boardId}/${virtualServer.apiTokens[boardId]?.token || ''}`;
            navigator.clipboard.writeText(apiKey).then(() => alert('API Endpoint copied!')).catch(() => alert('Copy failed.'));
        }

        // Submit post
        async function submitPost() {
            const input = document.getElementById('post-input');
            const fileInput = document.getElementById('file-input');
            if (!currentBoard) {
                alert('Join or create a bulletin.');
                return;
            }
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = async () => {
                    const fileData = {
                        type: 'file',
                        sessionId,
                        boardId: currentBoard,
                        fileName: file.name,
                        fileData: reader.result,
                        timestamp: Date.now()
                    };
                    await saveData(fileData);
                    appendFilePost(fileData);
                    dataChannel?.send(JSON.stringify(fileData));
                    fileInput.value = '';
                };
                reader.readAsDataURL(file);
            } else {
                const message = input.value.trim();
                if (message) {
                    const postData = {
                        type: 'post',
                        id: generateUUID(),
                        sessionId,
                        content: message,
                        boardId: currentBoard,
                        timestamp: Date.now()
                    };
                    await saveData(postData);
                    appendPost(`${sessionId}: ${message}`);
                    dataChannel?.send(JSON.stringify(postData));
                    input.value = '';
                } else {
                    alert('Enter a message or file.');
                }
            }
        }

        // Append text post
        function appendPost(text) {
            const posts = document.getElementById('board-posts');
            const postDiv = document.createElement('div');
            postDiv.className = 'post';
            postDiv.textContent = text;
            posts.appendChild(postDiv);
            posts.scrollTop = posts.scrollHeight;
        }

        // Append file post
        function appendFilePost(file) {
            const posts = document.getElementById('board-posts');
            const postDiv = document.createElement('div');
            postDiv.className = 'post';
            if (file.fileData.startsWith('data:image/')) {
                const img = document.createElement('img');
                img.src = file.fileData;
                postDiv.textContent = `${file.sessionId} shared image:`;
                postDiv.appendChild(img);
            } else {
                const link = document.createElement('a');
                link.href = file.fileData;
                link.download = file.fileName;
                link.textContent = file.fileName;
                postDiv.textContent = `${file.sessionId} shared file: `;
                postDiv.appendChild(link);
            }
            posts.appendChild(postDiv);
            posts.scrollTop = posts.scrollHeight;
        }

        // Load posts
        async function loadPosts() {
            const tx = db.transaction(['posts', 'files'], 'readonly');
            const posts = await new Promise(resolve => {
                tx.objectStore('posts').getAll().onsuccess = e => resolve(e.target.result);
            });
            const files = await new Promise(resolve => {
                tx.objectStore('files').getAll().onsuccess = e => resolve(e.target.result);
            });
            const postsDiv = document.getElementById('board-posts');
            postsDiv.innerHTML = '';
            posts.filter(p => p.boardId === currentBoard).sort((a, b) => a.timestamp - b.timestamp).forEach(post => {
                appendPost(`${post.sessionId}: ${post.content}`);
            });
            files.filter(f => f.boardId === currentBoard).sort((a, b) => a.timestamp - b.timestamp).forEach(file => {
                appendFilePost(file);
            });
        }

        // Modal handlers
        function showCreateBoardModal() {
            document.getElementById('modal-title').textContent = 'Create API Bulletin';
            document.getElementById('modal-action').textContent = 'Create';
            document.getElementById('board-id-input').value = generateUUID();
            document.getElementById('creator-input').value = '';
            document.getElementById('password-input').value = '';
            document.getElementById('public-board').checked = true;
            document.getElementById('public-boards').style.display = 'none';
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('modal-action').onclick = handleCreateBoard;
        }

        function showJoinBoardModal() {
            document.getElementById('modal-title').textContent = 'Join API Bulletin';
            document.getElementById('modal-action').textContent = 'Join';
            document.getElementById('board-id-input').value = '';
            document.getElementById('creator-input').value = '';
            document.getElementById('password-input').value = '';
            document.getElementById('public-boards').style.display = 'block';
            document.getElementById('board-id-input').style.display = 'block';
            document.getElementById('creator-input').style.display = 'block';
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('modal-action').onclick = handleJoinBoard;
            loadPublicBoards();
        }

        async function loadPublicBoards() {
            const tx = db.transaction('bulletins', 'readonly');
            const bulletins = await new Promise(resolve => {
                tx.objectStore('bulletins').getAll().onsuccess = e => resolve(e.target.result);
            });
            const select = document.getElementById('public-boards');
            select.innerHTML = '<option value="">Select Public API Bulletin</option>';
            bulletins.filter(b => b.public).forEach(bulletin => {
                const option = document.createElement('option');
                option.value = bulletin.id;
                option.textContent = `Bulletin by ${bulletin.creator} (${bulletin.id.slice(0, 8)})`;
                select.appendChild(option);
            });
            select.onchange = () => {
                const selectedBoard = select.value;
                document.getElementById('creator-input').style.display = selectedBoard ? 'none' : 'block';
                document.getElementById('board-id-input').style.display = selectedBoard ? 'none' : 'block';
                if (selectedBoard) {
                    document.getElementById('board-id-input').value = selectedBoard;
                }
            };
        }

        function refreshPublicBoards() {
            loadPublicBoardsList();
            loadPublicBoards();
        }

        // Clean up on exit
        window.onbeforeunload = async () => {
            if (isCreator) {
                const tx = db.transaction(['bulletins', 'posts', 'files', 'tokens'], 'readwrite');
                tx.objectStore('bulletins').delete(boardId);
                tx.objectStore('posts').delete(boardId);
                tx.objectStore('files').delete(boardId);
                tx.objectStore('tokens').delete(boardId);
                await new Promise(resolve => tx.oncomplete = resolve);
                await unregisterServiceWorker();
                peerConnections.get(boardId)?.close();
                peerConnections.delete(boardId);
            }
            localStorage.removeItem('boardId');
            localStorage.removeItem('sessionId');
        };

        // Check login state
        async function checkLogin() {
            if (boardId && sessionId) {
                const tx = db.transaction('bulletins', 'readonly');
                const bulletin = await new Promise(resolve => {
                    tx.objectStore('bulletins').get(boardId).onsuccess = e => resolve(e.target.result);
                });
                if (bulletin) {
                    currentBoard = boardId;
                    isCreator = bulletin.creatorSessionId === sessionId;
                    initializeApp(bulletin.public, bulletin.password);
                } else {
                    document.getElementById('start-menu').style.display = 'flex';
                    loadPublicBoardsList();
                }
            } else {
                document.getElementById('start-menu').style.display = 'flex';
                loadPublicBoardsList();
            }
        }

        // Initialize
        checkLogin();
    </script>
</body>
</html>
